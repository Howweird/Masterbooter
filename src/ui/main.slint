// ============================================
// MasterBooter - main.slint
// ============================================
// This file defines the user interface layout.
// Slint uses a declarative syntax - you describe WHAT the UI looks like,
// and Slint figures out HOW to draw it.
//
// Key concepts:
// - Components: Reusable UI pieces (like Button, Text)
// - Properties: Settings for components (text, color, size)
// - Callbacks: Functions called when something happens (click, etc.)
// ============================================

// Import standard widgets from Slint's library
import { Button, VerticalBox, HorizontalBox, ScrollView, LineEdit, ComboBox } from "std-widgets.slint";

// ============================================
// THEME COLORS
// ============================================
// Define our dark theme colors in one place.
// This makes it easy to change the look of the whole app.

global Theme {
    // ============================================
    // AMPIPIT-INSPIRED COLOR THEME
    // Deep ocean blue with teal and orange accents
    // ============================================

    // Background colors (deep space blue tones)
    out property <color> background-dark: #0B1426;      // Deep space blue (main background)
    out property <color> sidebar-bg: #0D1729;           // Darker sidebar
    out property <color> card-bg: #1E2A3A;              // Card/surface background
    out property <color> card-hover: #2A3B4D;           // Card hover state
    out property <color> status-bar-bg: #08101A;        // Dark status bar

    // Text colors
    out property <color> text-primary: #FFFFFF;         // White primary text
    out property <color> text-secondary: #BDC3C7;       // Grey secondary text
    out property <color> text-muted: #7F8C8D;           // Muted/disabled text

    // Accent colors (AMPIPIT style)
    out property <color> accent-blue: #3498DB;          // Bright blue (primary)
    out property <color> accent-teal: #1ABC9C;          // Teal/cyan (success/positive)
    out property <color> accent-green: #1ABC9C;         // Alias for teal (compatibility)
    out property <color> accent-orange: #F39C12;        // Orange (warning/info)
    out property <color> accent-yellow: #F39C12;        // Alias for orange (compatibility)
    out property <color> accent-red: #E74C3C;           // Red (error/danger)

    // Button colors
    out property <color> button-bg: #2A3B4D;            // Surface button
    out property <color> button-hover: #34495E;         // Hovered button
    out property <color> button-selected: #1ABC9C;      // Selected/active (teal)
}

// ============================================
// SIDEBAR BUTTON COMPONENT
// ============================================
// A custom button for the sidebar navigation.
// Changes appearance when hovered or selected.

component SidebarButton inherits Rectangle {
    // Properties that can be set from outside
    in property <string> label: "Button";
    in property <bool> selected: false;
    in property <bool> button-enabled: true;  // When false, button is greyed out and unclickable

    // Callback when clicked
    callback clicked();

    // Sizing - let the parent layout control width
    height: 44px;
    horizontal-stretch: 1;

    // Appearance changes based on state
    // Disabled buttons use a dimmer background with no hover effect
    background: !button-enabled ? Theme.sidebar-bg :
                selected ? Theme.button-selected :
                touch.has-hover ? Theme.button-hover : Theme.button-bg;
    border-radius: 8px;
    opacity: button-enabled ? 1.0 : 0.5;

    // The button text
    Text {
        text: label;
        color: !button-enabled ? Theme.text-muted :
               selected ? Theme.sidebar-bg : Theme.text-primary;
        font-size: 14px;
        font-weight: 600;
        vertical-alignment: center;
        horizontal-alignment: left;
        x: 15px;
        width: root.width - 30px;
        height: root.height;
    }

    // Handle mouse clicks (only when enabled)
    touch := TouchArea {
        width: root.width;
        height: root.height;
        enabled: root.button-enabled;
        clicked => {
            root.clicked();
        }
    }
}

// ============================================
// TOOL CARD COMPONENT
// ============================================
// A clickable card for displaying tool options.
// Used in the Backup/Restore section for tools like Fab's AutoBackup.

component ToolCard inherits Rectangle {
    // Properties
    in property <string> title: "Tool Name";
    in property <string> description: "Tool description goes here.";
    in property <string> badge: "Free";
    in property <color> badge-color: Theme.accent-green;
    in property <string> tool-id: "";

    // Callback when clicked
    callback clicked(string);

    // Sizing
    width: 280px;
    height: 140px;

    // Appearance
    background: touch.has-hover ? Theme.card-hover : Theme.card-bg;
    border-radius: 8px;

    // Content layout
    VerticalBox {
        padding: 20px;
        spacing: 8px;

        // Title
        Text {
            text: title;
            color: Theme.text-primary;
            font-size: 16px;
            font-weight: 600;
        }

        // Description
        Text {
            text: description;
            color: Theme.text-secondary;
            font-size: 12px;
            wrap: word-wrap;
            overflow: elide;
        }

        // Spacer
        Rectangle { vertical-stretch: 1; }

        // Badge
        Text {
            text: badge;
            color: badge-color;
            font-size: 10px;
        }
    }

    // Handle mouse clicks
    touch := TouchArea {
        clicked => {
            root.clicked(tool-id);
        }
    }
}

// ============================================
// SECTION HEADER COMPONENT
// ============================================
// A section header with uppercase text.

component SectionHeader inherits Text {
    color: Theme.text-secondary;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

// ============================================
// STATUS INDICATOR COMPONENT
// ============================================
// Shows a status with colored indicator dot

// (Unused components StatusIndicator, InfoCard, ActionButton, OptionRow removed — cleanup for release)

// ============================================
// PE CHECKBOX COMPONENT
// ============================================
// AMPIPIT-style checkbox for PE options

component PECheckbox inherits HorizontalBox {
    in-out property <bool> checked: true;
    in property <string> label: "Option";
    in property <string> description: "";
    in property <bool> enabled: true;

    spacing: 8px;
    height: description != "" ? 40px : 26px;

    Rectangle {
        width: 20px;
        height: 20px;
        background: checked ? Theme.accent-teal : Theme.button-bg;
        border-radius: 4px;
        opacity: enabled ? 1.0 : 0.5;
        y: (parent.height - self.height) / 2 - (description != "" ? 6px : 0px);

        Text {
            text: checked ? "✓" : "";
            color: Theme.sidebar-bg;
            font-size: 13px;
            font-weight: 700;
            horizontal-alignment: center;
            vertical-alignment: center;
        }

        TouchArea {
            enabled: root.enabled;
            clicked => { checked = !checked; }
        }
    }

    VerticalBox {
        spacing: 2px;
        vertical-stretch: 1;

        Text {
            text: label;
            color: enabled ? Theme.text-primary : Theme.text-muted;
            font-size: 12px;
            vertical-alignment: center;
        }

        if description != "": Text {
            text: description;
            color: Theme.text-muted;
            font-size: 10px;
        }
    }
}

// (Unused components CollapsibleSection, ModeTabButton removed — cleanup for release)

// ============================================
// TOOL LAUNCHER POPUP
// ============================================
// Modal popup for launching/downloading tools

component ToolLauncherPopup inherits Rectangle {
    in property <string> tool-name: "Tool";
    in property <string> tool-description: "Description";
    in property <string> tool-status: "Not installed";
    in property <bool> tool-installed: false;
    in property <string> tool-folder: "";
    in property <int> download-progress: -1;  // -1 = not downloading, 0-100 = progress

    callback launch-clicked();
    callback download-clicked();
    callback open-folder-clicked();
    callback close-clicked();

    // Full screen overlay
    background: #000000AA;

    // Close when clicking the background (MUST be before the card so card clicks aren't intercepted)
    TouchArea {
        width: 100%;
        height: 100%;
        clicked => { close-clicked(); }
    }

    // Centered popup card
    Rectangle {
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        width: 480px;
        height: 380px;  // Increased height for close button
        background: Theme.background-dark;
        border-radius: 12px;
        border-width: 1px;
        border-color: Theme.card-hover;

        // Block clicks on card from closing popup
        TouchArea {
            width: 100%;
            height: 100%;
        }

        VerticalBox {
            padding: 20px;
            spacing: 12px;

            // Header
            Text {
                text: tool-name;
                color: Theme.text-primary;
                font-size: 20px;
                font-weight: 700;
            }

            Text {
                text: tool-description;
                color: Theme.text-secondary;
                font-size: 12px;
                wrap: word-wrap;
            }

            // Status section
            Rectangle {
                height: 60px;
                background: Theme.card-bg;
                border-radius: 8px;

                HorizontalBox {
                    padding: 12px;
                    spacing: 12px;

                    VerticalBox {
                        spacing: 4px;
                        horizontal-stretch: 1;

                        Text {
                            text: "Status";
                            color: Theme.text-secondary;
                            font-size: 11px;
                        }

                        Text {
                            text: tool-status;
                            color: tool-installed ? Theme.accent-green : Theme.text-muted;
                            font-size: 13px;
                            font-weight: 600;
                        }
                    }

                    // Launch button
                    Rectangle {
                        width: 80px;
                        height: 36px;
                        background: tool-installed ? Theme.accent-blue : Theme.button-bg;
                        border-radius: 6px;
                        opacity: tool-installed ? 1.0 : 0.5;

                        Text {
                            text: "Launch";
                            color: tool-installed ? Theme.sidebar-bg : Theme.text-muted;
                            font-size: 12px;
                            font-weight: 600;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }

                        TouchArea {
                            enabled: tool-installed;
                            clicked => { launch-clicked(); }
                        }
                    }
                }
            }

            // Download section
            Rectangle {
                height: 60px;
                background: Theme.card-bg;
                border-radius: 8px;

                HorizontalBox {
                    padding: 12px;
                    spacing: 12px;

                    VerticalBox {
                        spacing: 4px;
                        horizontal-stretch: 1;

                        Text {
                            text: tool-installed ? "Update" : "Download";
                            color: Theme.text-secondary;
                            font-size: 11px;
                        }

                        Text {
                            text: download-progress >= 0 ?
                                  "Downloading... " + download-progress + "%" :
                                  "Download from official source";
                            color: Theme.text-muted;
                            font-size: 11px;
                        }
                    }

                    // Download button
                    Rectangle {
                        width: 90px;
                        height: 36px;
                        background: download-progress >= 0 ? Theme.button-bg : Theme.accent-green;
                        border-radius: 6px;

                        Text {
                            text: download-progress >= 0 ? download-progress + "%" :
                                  (tool-installed ? "Update" : "Download");
                            color: download-progress >= 0 ? Theme.text-muted : Theme.sidebar-bg;
                            font-size: 12px;
                            font-weight: 600;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }

                        TouchArea {
                            enabled: download-progress < 0;
                            clicked => { download-clicked(); }
                        }
                    }
                }
            }

            // Folder section
            Rectangle {
                height: 50px;
                background: Theme.card-bg;
                border-radius: 8px;

                HorizontalBox {
                    padding: 12px;
                    spacing: 12px;

                    VerticalBox {
                        spacing: 2px;
                        horizontal-stretch: 1;

                        Text {
                            text: "Tool Folder";
                            color: Theme.text-secondary;
                            font-size: 11px;
                        }

                        Text {
                            text: tool-folder;
                            color: Theme.text-muted;
                            font-size: 10px;
                            overflow: elide;
                        }
                    }

                    // Open folder button
                    Rectangle {
                        width: 90px;
                        height: 32px;
                        background: Theme.button-bg;
                        border-radius: 6px;

                        Text {
                            text: "Open Folder";
                            color: Theme.text-primary;
                            font-size: 11px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }

                        TouchArea {
                            clicked => { open-folder-clicked(); }
                        }
                    }
                }
            }

            // Spacer
            Rectangle { vertical-stretch: 1; }

            // Close button
            HorizontalBox {
                alignment: end;

                Rectangle {
                    width: 80px;
                    height: 36px;
                    background: Theme.button-bg;
                    border-radius: 6px;

                    Text {
                        text: "Close";
                        color: Theme.text-primary;
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    TouchArea {
                        clicked => { close-clicked(); }
                    }
                }
            }
        }
    }
}

// ============================================
// MAIN WINDOW
// ============================================
// This is the main application window.
// It's exported so main.rs can create it.

export component MainWindow inherits Window {
    // Window properties
    title: "MasterBooter";
    icon: @image-url("../../assets/icon.png");
    min-width: 700px;
    min-height: 500px;
    preferred-width: 900px;
    preferred-height: 600px;
    background: Theme.background-dark;

    // ============================================
    // PUBLIC PROPERTIES
    // ============================================
    // These can be read/written from Rust code

    // Environment detection
    in-out property <bool> is-winpe: false;

    // Version string
    in-out property <string> version: "v0.1.0";

    // ============================================
    // AUTO-UPDATE STATE
    // ============================================
    in-out property <bool> update-available: false;           // True when a newer version exists on GitHub
    in-out property <string> update-latest-version: "";       // e.g. "v1.2.0"
    in-out property <string> update-release-notes: "";        // Release notes from GitHub
    in-out property <string> update-download-url: "";         // Direct download URL for new EXE
    in-out property <string> update-size-display: "";         // e.g. "8.2 MB"
    in-out property <int> update-download-progress: -1;       // -1 = idle, 0-100 = downloading
    in-out property <bool> update-checking: false;            // True while checking GitHub
    in-out property <bool> update-installed: false;           // True after successful self-replace
    in-out property <string> update-error: "";                // Error message (empty on success)

    // Status bar text
    in-out property <string> status-text: "Ready - Select a mode from the sidebar";

    // Currently selected mode (0=Backup, 1=Deploy, 2=WinPE, 3=SysPrep)
    in-out property <int> current-mode: 0;

    // Tool launcher popup state
    in-out property <bool> show-tool-popup: false;
    in-out property <string> popup-tool-id: "";
    in-out property <string> popup-tool-name: "";
    in-out property <string> popup-tool-description: "";
    in-out property <string> popup-tool-status: "Not installed";
    in-out property <bool> popup-tool-installed: false;
    in-out property <string> popup-tool-folder: "";
    in-out property <int> popup-download-progress: -1;

    // Download All state (Backup/Restore page)
    in-out property <bool> download-all-active: false;     // True while downloading
    in-out property <string> download-all-progress: "";    // e.g. "2/5"

    // Windows Product Key backup (Backup/Restore page)
    in-out property <string> backup-oem-key: "";           // OEM/BIOS firmware key
    in-out property <string> backup-installed-key: "";     // Currently active key (decoded)
    in-out property <string> backup-key-edition: "";       // e.g., "Windows 11 Pro"
    in-out property <string> backup-key-status: "";        // e.g., "Licensed"
    in-out property <string> backup-key-saved-info: "";    // "Backed up 2026-02-18 from HOST"
    in-out property <bool> backup-key-detecting: false;    // True while detecting

    // ============================================
    // WINPE BUILDER STATE
    // ============================================

    // Local WinRE detection (from system recovery partition)
    in-out property <bool> winre-found: false;
    in-out property <string> winre-path: "";      // Path to local WinRE.wim
    in-out property <string> winre-size: "";

    // Windows ISO selection (for PE or RE builds)
    in-out property <bool> iso-selected: false;
    in-out property <string> iso-path: "";        // Path to selected Windows ISO
    in-out property <string> iso-size: "";

    // ADK detection
    in-out property <bool> adk-found: false;
    in-out property <string> adk-version: "";
    in-out property <string> adk-path: "";

    // WinPE Add-on detection
    in-out property <bool> winpe-addon-found: false;
    in-out property <string> winpe-addon-path: "";

    // Build dependencies
    in-out property <bool> oscdimg-found: false;
    in-out property <string> oscdimg-path: "";
    in-out property <bool> seven-zip-found: false;
    in-out property <string> seven-zip-path: "";
    in-out property <bool> dism-found: false;
    in-out property <bool> powershell-found: false;
    in-out property <bool> disk-space-ok: false;
    in-out property <float> disk-space-gb: 0.0;
    in-out property <bool> all-deps-satisfied: false;
    in-out property <string> deps-status: "";
    in-out property <bool> pe-detecting: false;  // True while detection is running

    // Build configuration
    // pe-source values:
    //   "LocalRE"  - Use local recovery partition (WinRE.wim)
    //   "ISO_PE"   - Use Windows ISO boot.wim for WinPE (deployment)
    //   "ISO_RE"   - Use Windows ISO for WinRE (recovery tools)
    in-out property <string> pe-source: "ISO_PE";
    in-out property <string> pe-output-path: "";
    // NOTE: Drivers, tools, and network support are ALWAYS included.
    // (Removing them produces broken PE images, so no UI toggle is needed.)

    // Build progress
    in-out property <bool> pe-building: false;
    in-out property <int> pe-build-progress: 0;
    in-out property <string> pe-build-status: "";

    // ============================================
    // PE TOOLS STATE
    // ============================================
    // Tools to include in the PE build

    // Tool counts and summary
    in-out property <string> pe-tools-summary: "8 tools available";

    // Shell tools
    in-out property <bool> pe-tool-winxshell: true;
    in-out property <bool> pe-tool-explorer: true;

    // Network tools
    in-out property <bool> pe-tool-penetwork: true;

    // Disk tools
    in-out property <bool> pe-tool-crystaldisk: true;
    in-out property <bool> pe-tool-diskcheck: true;

    // Utility tools
    in-out property <bool> pe-tool-7zip: true;
    in-out property <bool> pe-tool-autoruns: true;

    // System / Repair tools
    in-out property <bool> pe-tool-dismtool: true;

    // PE-specific tools (from pcassistsoftware.co.uk)
    in-out property <bool> pe-tool-webbrowser: true;
    in-out property <bool> pe-tool-eventviewer: true;
    in-out property <bool> pe-tool-installedsw: true;
    in-out property <bool> pe-tool-fileexplorer: true;

    // ============================================
    // PE TOOL DOWNLOAD STATUS
    // ============================================
    // True = tool EXE is present on disk (downloaded and extracted)
    // False = tool is missing, needs to be downloaded before build
    in-out property <bool> pe-tool-winxshell-present: false;
    in-out property <bool> pe-tool-explorer-present: false;
    in-out property <bool> pe-tool-penetwork-present: false;
    in-out property <bool> pe-tool-crystaldisk-present: false;
    in-out property <bool> pe-tool-diskcheck-present: false;
    in-out property <bool> pe-tool-7zip-present: false;
    in-out property <bool> pe-tool-autoruns-present: false;
    in-out property <bool> pe-tool-dismtool-present: false;
    in-out property <bool> pe-tool-webbrowser-present: false;
    in-out property <bool> pe-tool-eventviewer-present: false;
    in-out property <bool> pe-tool-installedsw-present: false;
    in-out property <bool> pe-tool-fileexplorer-present: false;

    // Download All PE Tools state
    in-out property <bool> pe-tools-download-active: false;   // True while downloading
    in-out property <string> pe-tools-download-progress: "";  // e.g. "2/6"

    // ============================================
    // ADK PACKAGES (Optional WinPE Components)
    // ============================================
    // These control which ADK packages are installed into the WinPE image.
    // Enabling packages adds functionality but increases image size.

    // Master toggle for package installation
    in-out property <bool> pe-install-packages: true;

    // Core packages
    in-out property <bool> pe-pkg-wmi: true;           // Windows Management Instrumentation
    in-out property <bool> pe-pkg-netfx: true;         // .NET Framework support
    in-out property <bool> pe-pkg-scripting: true;     // Windows Script Host

    // PowerShell packages
    in-out property <bool> pe-pkg-powershell: true;    // PowerShell support
    in-out property <bool> pe-pkg-dism-cmdlets: false;  // DISM cmdlets — fails 0x800f081e, not needed
    in-out property <bool> pe-pkg-secureboot-cmdlets: true; // Secure Boot cmdlets

    // Storage packages
    in-out property <bool> pe-pkg-storage-wmi: true;   // Storage WMI (for NVMe)
    in-out property <bool> pe-pkg-enhanced-storage: true; // Enhanced storage
    in-out property <bool> pe-pkg-fmapi: true;         // File Management API

    // Network packages
    in-out property <bool> pe-pkg-dot3svc: true;       // 802.1X authentication (enterprise wired networks)
    in-out property <bool> pe-pkg-wifi: true;          // WiFi support
    in-out property <bool> pe-pkg-pppoe: false;        // PPPoE
    in-out property <bool> pe-pkg-rndis: true;         // USB network (RNDIS)

    // Security packages
    in-out property <bool> pe-pkg-secure-startup: true; // BitLocker support
    in-out property <bool> pe-pkg-hta: true;           // HTML Applications (needed for many PE tools)
    in-out property <bool> pe-pkg-hsp-driver: false;   // Pluton HSP driver

    // Recovery packages
    in-out property <bool> pe-pkg-winrecfg: true;      // WinRE configuration
    in-out property <bool> pe-pkg-font-support: true;  // Additional fonts (prevents rendering issues)
    in-out property <bool> pe-pkg-platform-id: true;   // Platform identification
    in-out property <bool> pe-pkg-wds-tools: true;     // WDS client tools
    in-out property <bool> pe-pkg-rejuv: false;        // Recovery rejuv — .cab not in ADK
    in-out property <bool> pe-pkg-srt: false;          // Startup Repair — .cab not in ADK

    // Setup packages (for Windows installation from PE)
    in-out property <bool> pe-pkg-setup: true;         // Windows Setup support
    in-out property <bool> pe-pkg-setup-client: true;  // Client setup branding
    in-out property <bool> pe-pkg-setup-server: false; // Server setup branding
    in-out property <bool> pe-pkg-legacy-setup: false; // Legacy setup support

    // Storage packages (additional)
    in-out property <bool> pe-pkg-mdac: false;         // Database connectivity

    // Font packages (international)
    in-out property <bool> pe-pkg-fonts-legacy: false;             // Legacy fonts
    in-out property <bool> pe-pkg-fonts-japanese: false;           // Japanese
    in-out property <bool> pe-pkg-fonts-korean: false;             // Korean
    in-out property <bool> pe-pkg-fonts-chinese-simplified: false; // Chinese (Simplified)
    in-out property <bool> pe-pkg-fonts-chinese-traditional: false;// Chinese (Traditional)
    in-out property <bool> pe-pkg-fonts-chinese-hk: false;         // Chinese (Hong Kong)

    // Input packages
    in-out property <bool> pe-pkg-gaming-peripherals: false;  // Xbox controller support

    // ============================================
    // HOVER DESCRIPTION
    // ============================================
    // Shows description text when hovering over options
    in-out property <string> pe-hover-description: "";

    // ============================================
    // PE FIXES (Workarounds and Enhancements)
    // ============================================
    // These control which fixes/workarounds are applied to the WinPE image.

    // Master toggle for applying fixes
    in-out property <bool> pe-apply-fixes: true;

    // Display fixes
    in-out property <bool> pe-fix-dpi-scaling: true;      // DPI scaling fix for high-DPI displays
    in-out property <bool> pe-fix-wallpaper-host: true;   // Remove WallpaperHost.exe
    in-out property <bool> pe-fix-font-fix: true;         // Segoe UI italic fix

    // System fixes
    in-out property <bool> pe-fix-profile-folders: true;  // Create user profile folders
    in-out property <bool> pe-fix-temp-folders: true;     // Configure TEMP folders
    in-out property <bool> pe-fix-file-associations: true; // Register file associations

    // Compatibility fixes
    in-out property <bool> pe-fix-crash-dialogs: true;    // Disable crash dialogs
    in-out property <bool> pe-fix-long-paths: true;       // Enable long path support

    // ============================================
    // OUTPUT OPTIONS
    // ============================================
    // pe-output-type: "ISO", "USB", or "VHD"
    in-out property <string> pe-output-type: "ISO";
    in-out property <bool> pe-use-uefi-2023-ca: true;     // Use UEFI 2023 CA signed boot manager
    in-out property <bool> pe-backup-original: true;      // Backup original WinRE (for Local RE mode)

    // ============================================
    // SHELL CONFIGURATION
    // ============================================
    // Which shell to use as default when PE boots
    // pe-default-shell: "WinXShell", "Explorer++", or "CMD"
    in-out property <string> pe-default-shell: "WinXShell";

    // ============================================
    // STARTUP OPTIONS
    // ============================================
    in-out property <bool> pe-startup-init-network: true;     // Initialize network on startup
    in-out property <bool> pe-startup-high-performance: true; // Enable high performance power plan
    in-out property <string> pe-startup-custom-commands: "";  // Custom startup commands

    // ============================================
    // BRANDING
    // ============================================
    in-out property <bool> pe-branding-enabled: false;        // Enable custom branding
    in-out property <string> pe-branding-wallpaper-path: "";  // Custom wallpaper path

    // ============================================
    // DRIVER PATHS
    // ============================================
    in-out property <bool> pe-drivers-recurse: true;          // Recurse into subfolders
    in-out property <string> pe-driver-paths: "";             // Semicolon-separated driver paths

    // ============================================
    // SECTION COLLAPSE STATE (for collapsible UI sections)
    // ============================================
    in-out property <bool> pe-section-shell-expanded: true;
    in-out property <bool> pe-section-apps-expanded: true;
    in-out property <bool> pe-section-components-expanded: false;
    in-out property <bool> pe-section-fixes-expanded: false;
    in-out property <bool> pe-section-drivers-expanded: true;
    in-out property <bool> pe-section-startup-expanded: false;

    // ============================================
    // CALLBACKS
    // ============================================
    // These are called when UI events happen

    callback mode-changed(string);
    callback settings-clicked();
    callback tool-clicked(string);
    callback tool-launch-clicked(string);
    callback tool-download-clicked(string);
    callback tool-open-folder-clicked(string);
    callback download-all-clicked();             // Download all backup tools at once

    // Product Key backup callbacks
    callback backup-detect-key();                // Detect OEM + installed keys via PowerShell
    callback backup-copy-key(string);            // Copy a key string to clipboard
    callback backup-save-key();                  // Save detected keys to saved_keys.json

    // Deploy: saved keys management (multi-key support)
    // The ComboBox shows all saved keys by "HOSTNAME (date)" label.
    // User selects one, clicks Load to fill the product key field, or Delete to remove it.
    in-out property <[string]> deploy-saved-key-labels;  // Labels for saved keys ComboBox
    in-out property <int> deploy-saved-key-index: -1;    // Currently selected index in ComboBox (-1 = none)
    callback deploy-load-saved-key-at(int);              // Load key at given index into product key field
    callback deploy-delete-saved-key(int);               // Delete key at given index
    callback deploy-refresh-saved-keys();                // Refresh the ComboBox model from saved_keys.json

    // WinPE Builder callbacks
    callback pe-detect-winre();           // Detect local WinRE and all dependencies
    callback pe-install-adk();            // Install ALL dependencies (7-Zip, ADK, WinPE Add-on)
    callback pe-browse-source();          // Browse for ISO source
    callback pe-browse-output();          // Browse for output path
    callback pe-build();                  // Start build (works for all modes)
    callback pe-open-output-folder();     // Open output folder
    callback pe-download-all-tools();     // Download all enabled PE tools

    // Auto-update callbacks
    callback check-for-updates();           // Manual check (from Settings button)
    callback download-update();             // Start downloading and replacing the EXE
    callback dismiss-update();              // User dismisses the update notification

    // ============================================
    // WINDOWS DEPLOY STATE
    // ============================================

    // Install mode: 0 = show cards (Normal vs Automated), 1 = normal install, 2 = automated
    in-out property <int> deploy-install-mode: 0;

    // Image selection
    in-out property <string> deploy-wim-path: "";           // Full path to WIM/ESD/ISO
    in-out property <string> deploy-wim-name: "";           // Filename only for display
    in-out property <[string]> deploy-edition-list: [];     // ComboBox model: edition names
    in-out property <string> deploy-selected-edition-name: "";  // Currently selected edition name

    // Disk selection
    in-out property <[string]> deploy-disk-list: [];        // ComboBox model: disk display strings
    in-out property <string> deploy-selected-disk-name: ""; // Currently selected disk display string
    in-out property <bool> deploy-let-windows-choose: false;

    // Machine settings
    in-out property <string> deploy-computer-name: "*";
    in-out property <string> deploy-timezone: "Eastern Standard Time";
    in-out property <string> deploy-language: "en-US";
    in-out property <string> deploy-boot-mode: "UEFI";

    // User account
    in-out property <string> deploy-user-name: "Admin";
    in-out property <string> deploy-user-password: "";
    in-out property <string> deploy-user-display-name: "Administrator";
    in-out property <bool> deploy-user-is-admin: true;
    in-out property <bool> deploy-enable-autologon: true;

    // OOBE
    in-out property <bool> deploy-skip-oobe: true;
    in-out property <bool> deploy-skip-eula: true;
    in-out property <bool> deploy-skip-network: false;
    in-out property <bool> deploy-bypass-win11: true;

    // Registration
    in-out property <string> deploy-product-key: "";
    in-out property <string> deploy-organization: "";
    in-out property <string> deploy-owner-name: "";

    // Privacy tweaks (6)
    in-out property <bool> deploy-disable-telemetry: true;
    in-out property <bool> deploy-disable-location: true;
    in-out property <bool> deploy-disable-ads: true;
    in-out property <bool> deploy-disable-suggested-apps: true;
    in-out property <bool> deploy-disable-bing-search: true;
    in-out property <bool> deploy-disable-smartscreen: false;

    // Security tweaks (6)
    in-out property <bool> deploy-enable-rdp: true;
    in-out property <bool> deploy-disable-uac: false;
    in-out property <bool> deploy-disable-defender: false;
    in-out property <bool> deploy-disable-firewall: false;
    in-out property <bool> deploy-disable-vbs: false;
    in-out property <bool> deploy-disable-bitlocker: true;

    // Performance tweaks (3)
    in-out property <bool> deploy-disable-fast-startup: true;
    in-out property <bool> deploy-high-performance: true;
    in-out property <bool> deploy-disable-system-restore: false;

    // UI tweaks (7)
    in-out property <bool> deploy-show-file-extensions: true;
    in-out property <bool> deploy-show-hidden-files: false;
    in-out property <bool> deploy-classic-context-menu: true;
    in-out property <int> deploy-taskbar-search-mode: 2;    // 0=show, 1=icon, 2=hidden
    in-out property <bool> deploy-hide-task-view: true;
    in-out property <bool> deploy-hide-widgets: true;
    in-out property <bool> deploy-taskbar-left-align: false;

    // Bloatware (5)
    in-out property <bool> deploy-disable-cortana: true;
    in-out property <bool> deploy-disable-onedrive: false;
    in-out property <bool> deploy-disable-teams: true;
    in-out property <bool> deploy-disable-copilot: true;
    in-out property <bool> deploy-disable-widgets-service: true;

    // Domain join
    in-out property <bool> deploy-join-domain: false;
    in-out property <string> deploy-domain-name: "";
    // OU path removed — not needed for basic domain join
    in-out property <string> deploy-domain-username: "";
    in-out property <string> deploy-domain-password: "";
    in-out property <string> deploy-workgroup: "WORKGROUP";

    // Execution state
    in-out property <bool> deploy-building: false;
    in-out property <int> deploy-build-progress: 0;
    in-out property <string> deploy-build-status: "";
    in-out property <bool> deploy-detecting: false;

    // Scripts (semicolon-separated filenames)
    in-out property <string> deploy-firstlogon-scripts: "";     // "script1.ps1;script2.bat;..."

    // Profiles
    in-out property <[string]> deploy-profile-list: [];     // Model for ComboBox dropdown
    in-out property <string> deploy-active-profile: "";     // Currently selected profile name
    in-out property <string> deploy-profile-name-input: ""; // Text input for saving new profiles

    // Section collapse states
    in-out property <bool> deploy-section-image-expanded: true;
    in-out property <bool> deploy-section-disk-expanded: true;
    in-out property <bool> deploy-section-user-expanded: true;
    in-out property <bool> deploy-section-oobe-expanded: true;
    in-out property <bool> deploy-section-privacy-expanded: false;
    in-out property <bool> deploy-section-security-expanded: false;
    in-out property <bool> deploy-section-performance-expanded: false;
    in-out property <bool> deploy-section-ui-expanded: false;
    in-out property <bool> deploy-section-bloatware-expanded: false;
    in-out property <bool> deploy-section-domain-expanded: false;
    in-out property <bool> deploy-section-profile-expanded: false;

    // Windows Deploy callbacks
    callback deploy-browse-image();
    callback deploy-refresh-editions();
    callback deploy-refresh-disks();
    callback deploy-start();
    callback deploy-save-profile(string);       // Save current settings as a named profile
    callback deploy-select-profile(string);     // Auto-load when user picks from ComboBox
    callback deploy-import-profile();           // Open file picker to import a .json profile
    callback deploy-delete-profile(string);     // Delete the currently selected profile
    callback deploy-refresh-profiles();         // Refresh the ComboBox profile list
    callback deploy-preview-xml();
    callback deploy-start-normal();                           // Launch interactive setup.exe (no answer file)
    callback deploy-add-firstlogon-script();                  // File picker → copy to FirstLogon/
    callback deploy-remove-firstlogon-script(string);         // Delete named script
    callback deploy-refresh-scripts();                        // Rescan FirstLogon script folder

    // ============================================
    // LAYOUT
    // ============================================

    VerticalBox {
        padding: 0;
        spacing: 0;

        // Main content area (sidebar + content)
        HorizontalBox {
            padding: 0;
            spacing: 0;
            vertical-stretch: 1;

            // ========================================
            // LEFT SIDEBAR
            // ========================================
            Rectangle {
                width: 200px;
                background: Theme.sidebar-bg;

                VerticalBox {
                    padding: 0;
                    spacing: 0;

                    // App title + version (with update notification)
                    Rectangle {
                        // Taller when update badge is shown
                        height: update-available && !update-installed ? 105px : 80px;
                        VerticalBox {
                            padding-left: 15px;
                            padding-top: 20px;
                            spacing: 2px;

                            // App name
                            Text {
                                text: "MasterBooter";
                                color: Theme.accent-blue;
                                font-size: 22px;
                                font-weight: 700;
                            }

                            // Version text — shows restart hint after update installed
                            Text {
                                text: update-installed ? version + " (restart needed)" : version;
                                color: update-installed ? Theme.accent-orange : Theme.text-secondary;
                                font-size: 11px;
                            }

                            // Update badge — only shown when an update is available
                            if update-available && !update-installed: Rectangle {
                                height: 24px;
                                background: Theme.accent-orange;
                                border-radius: 4px;
                                width: 170px;

                                HorizontalBox {
                                    padding-left: 8px;
                                    padding-right: 8px;
                                    alignment: center;

                                    Text {
                                        text: update-checking ? "Checking..." :
                                              update-download-progress >= 0 ?
                                                  "Downloading " + update-download-progress + "%" :
                                                  "Update " + update-latest-version + " available";
                                        color: Theme.sidebar-bg;
                                        font-size: 10px;
                                        font-weight: 600;
                                        vertical-alignment: center;
                                    }
                                }

                                // Click the badge to start downloading the update
                                TouchArea {
                                    enabled: update-download-progress < 0 && !update-checking;
                                    clicked => { download-update(); }
                                }
                            }
                        }
                    }

                    // Navigation buttons
                    VerticalBox {
                        padding: 0;
                        spacing: 4px;

                        SidebarButton {
                            label: "Backup/Restore";
                            selected: current-mode == 0;
                            clicked => {
                                current-mode = 0;
                                mode-changed("Backup/Restore");
                            }
                        }

                        SidebarButton {
                            label: "Windows Deploy";
                            selected: current-mode == 1;
                            clicked => {
                                current-mode = 1;
                                mode-changed("Windows Deploy");
                            }
                        }

                        SidebarButton {
                            label: "WinPE Builder";
                            selected: current-mode == 2;
                            button-enabled: !is-winpe;  // Disabled in PE environment
                            clicked => {
                                current-mode = 2;
                                mode-changed("WinPE Builder");
                            }
                        }

                        SidebarButton {
                            label: "System Prep";
                            selected: current-mode == 3;
                            button-enabled: !is-winpe;  // Disabled in PE environment
                            clicked => {
                                current-mode = 3;
                                mode-changed("System Prep");
                            }
                        }
                    }

                    // Spacer
                    Rectangle { vertical-stretch: 1; }

                    // Settings button at bottom
                    Rectangle {
                        height: 60px;
                        SidebarButton {
                            label: "Settings";
                            selected: false;
                            y: 8px;
                            clicked => {
                                settings-clicked();
                            }
                        }
                    }
                }
            }

            // ========================================
            // MAIN CONTENT AREA
            // ========================================
            Rectangle {
                horizontal-stretch: 1;
                background: Theme.background-dark;

                ScrollView {
                    VerticalBox {
                        padding: 20px;
                        spacing: 10px;

                        // ============================
                        // BACKUP/RESTORE VIEW
                        // ============================
                        if current-mode == 0: VerticalBox {
                            spacing: 20px;

                            // Header
                            Text {
                                text: "Backup / Restore";
                                color: Theme.text-primary;
                                font-size: 28px;
                                font-weight: 700;
                            }
                            Text {
                                text: "Backup user profiles, create disk images, or restore from backup.";
                                color: Theme.text-secondary;
                                font-size: 14px;
                            }

                            // BUNDLED TOOLS section header + Download All button
                            HorizontalBox {
                                spacing: 12px;
                                alignment: start;

                                // Section label (same style as SectionHeader)
                                Text {
                                    text: "BUNDLED TOOLS";
                                    color: Theme.text-secondary;
                                    font-size: 12px;
                                    font-weight: 600;
                                    letter-spacing: 0.5px;
                                    vertical-alignment: center;
                                }

                                // Download All button
                                Rectangle {
                                    width: download-all-active ? 160px : 110px;
                                    height: 28px;
                                    background: download-all-active ? Theme.button-bg : Theme.accent-green;
                                    border-radius: 6px;

                                    Text {
                                        text: download-all-active
                                            ? "Downloading " + download-all-progress + "..."
                                            : "Download All";
                                        color: download-all-active ? Theme.text-muted : Theme.sidebar-bg;
                                        font-size: 11px;
                                        font-weight: 600;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }

                                    TouchArea {
                                        enabled: !download-all-active;
                                        clicked => { download-all-clicked(); }
                                    }
                                }
                            }

                            HorizontalBox {
                                spacing: 15px;
                                alignment: start;

                                ToolCard {
                                    title: "Fab's AutoBackup";
                                    description: "Professional user profile backup and restore tool.";
                                    badge: "Bundled - by Fabrice";
                                    badge-color: Theme.accent-green;
                                    tool-id: "fabs";
                                    clicked(id) => { tool-clicked(id); }
                                }

                                ToolCard {
                                    title: "ProfWiz";
                                    description: "Migrate user profiles between domains or computers.";
                                    badge: "By ForensiT - Profile Migration";
                                    badge-color: Theme.accent-blue;
                                    tool-id: "profwiz";
                                    clicked(id) => { tool-clicked(id); }
                                }

                                ToolCard {
                                    title: "Transwiz";
                                    description: "Transfer user profiles to a new computer.";
                                    badge: "By ForensiT - Profile Transfer";
                                    badge-color: Theme.accent-blue;
                                    tool-id: "transwiz";
                                    clicked(id) => { tool-clicked(id); }
                                }
                            }

                            // DISK IMAGING section
                            SectionHeader { text: "DISK IMAGING"; }

                            HorizontalBox {
                                spacing: 15px;
                                alignment: start;

                                ToolCard {
                                    title: "Disk2VHD";
                                    description: "Create VHD/VHDX disk images from physical disks.";
                                    badge: "Microsoft Sysinternals - Free";
                                    badge-color: Theme.accent-green;
                                    tool-id: "disk2vhd";
                                    clicked(id) => { tool-clicked(id); }
                                }

                                ToolCard {
                                    title: "HDD Raw Copy Tool";
                                    description: "Sector-by-sector raw disk copy and cloning.";
                                    badge: "By HDDGURU - Free";
                                    badge-color: Theme.accent-green;
                                    tool-id: "hddrawcopy";
                                    clicked(id) => { tool-clicked(id); }
                                }
                            }

                            // WINDOWS PRODUCT KEY section
                            SectionHeader { text: "WINDOWS PRODUCT KEY"; }

                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: key-backup-layout.preferred-height;
                                key-backup-layout := VerticalBox {
                                    padding: 16px;
                                    spacing: 10px;

                                    Text {
                                        text: "Detect and save your Windows product key before reinstalling. Saved keys persist on this USB drive and can be loaded in the Deploy section.";
                                        color: Theme.text-muted;
                                        font-size: 11px;
                                        wrap: word-wrap;
                                    }

                                    // OEM Key row
                                    HorizontalBox {
                                        spacing: 8px;
                                        Text { text: "OEM Key:"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; vertical-alignment: center; width: 100px; }
                                        Text {
                                            text: backup-oem-key != "" ? backup-oem-key : "(not detected)";
                                            color: backup-oem-key != "" ? Theme.text-primary : Theme.text-muted;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                            horizontal-stretch: 1;
                                        }
                                        if backup-oem-key != "": Rectangle {
                                            width: 45px; height: 24px; background: Theme.accent-blue; border-radius: 4px;
                                            Text { text: "Copy"; color: white; font-size: 10px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { backup-copy-key(backup-oem-key); } }
                                        }
                                    }

                                    // Installed Key row
                                    HorizontalBox {
                                        spacing: 8px;
                                        Text { text: "Installed Key:"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; vertical-alignment: center; width: 100px; }
                                        Text {
                                            text: backup-installed-key != "" ? backup-installed-key : "(not detected)";
                                            color: backup-installed-key != "" ? Theme.text-primary : Theme.text-muted;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                            horizontal-stretch: 1;
                                        }
                                        if backup-installed-key != "": Rectangle {
                                            width: 45px; height: 24px; background: Theme.accent-blue; border-radius: 4px;
                                            Text { text: "Copy"; color: white; font-size: 10px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { backup-copy-key(backup-installed-key); } }
                                        }
                                    }

                                    // Edition + Status row
                                    HorizontalBox {
                                        spacing: 16px;
                                        HorizontalBox {
                                            spacing: 8px;
                                            Text { text: "Edition:"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; vertical-alignment: center; }
                                            Text { text: backup-key-edition != "" ? backup-key-edition : "—"; color: Theme.text-primary; font-size: 12px; vertical-alignment: center; }
                                        }
                                        HorizontalBox {
                                            spacing: 8px;
                                            Text { text: "Status:"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; vertical-alignment: center; }
                                            Text { text: backup-key-status != "" ? backup-key-status : "—"; color: Theme.text-primary; font-size: 12px; vertical-alignment: center; }
                                        }
                                    }

                                    // Action buttons: Detect + Save
                                    HorizontalBox {
                                        spacing: 12px;
                                        alignment: start;

                                        // Detect Key button
                                        Rectangle {
                                            width: backup-key-detecting ? 140px : 100px;
                                            height: 32px;
                                            background: backup-key-detecting ? Theme.button-bg : Theme.accent-teal;
                                            border-radius: 6px;
                                            Text {
                                                text: backup-key-detecting ? "Detecting..." : "Detect Key";
                                                color: backup-key-detecting ? Theme.text-muted : Theme.sidebar-bg;
                                                font-size: 12px; font-weight: 600;
                                                horizontal-alignment: center; vertical-alignment: center;
                                            }
                                            TouchArea {
                                                enabled: !backup-key-detecting;
                                                clicked => { backup-detect-key(); }
                                            }
                                        }

                                        // Save to File button (only shows after detection)
                                        if backup-installed-key != "" || backup-oem-key != "": Rectangle {
                                            width: 100px; height: 32px;
                                            background: Theme.accent-green; border-radius: 6px;
                                            Text { text: "Save to File"; color: Theme.sidebar-bg; font-size: 12px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { backup-save-key(); } }
                                        }
                                    }

                                    // Saved key file info
                                    if backup-key-saved-info != "": Text {
                                        text: backup-key-saved-info;
                                        color: Theme.accent-green;
                                        font-size: 11px;
                                    }
                                }
                            }
                        }

                        // ============================
                        // WINDOWS DEPLOY VIEW
                        // ============================
                        if current-mode == 1: VerticalBox {
                            spacing: 20px;

                            // Page header
                            Text {
                                text: "Windows Deploy";
                                color: Theme.text-primary;
                                font-size: 28px;
                                font-weight: 700;
                            }

                            // ============================================
                            // MODE SELECTION CARDS (deploy-install-mode == 0)
                            // ============================================
                            if deploy-install-mode == 0: VerticalBox {
                                spacing: 16px;
                                Text {
                                    text: "Choose an installation method:";
                                    color: Theme.text-secondary;
                                    font-size: 14px;
                                }
                                HorizontalBox {
                                    spacing: 20px;
                                    // Normal Install card
                                    Rectangle {
                                        horizontal-stretch: 1;
                                        height: 180px;
                                        background: Theme.card-bg;
                                        border-radius: 12px;
                                        border-width: 2px;
                                        border-color: Theme.accent-teal;
                                        VerticalBox {
                                            padding: 20px;
                                            spacing: 10px;
                                            alignment: center;
                                            Text { text: "Normal Install"; color: Theme.accent-teal; font-size: 20px; font-weight: 700; horizontal-alignment: center; }
                                            Text { text: "Interactive setup — Windows\nwill prompt for all options.\nScripts can still be copied."; color: Theme.text-secondary; font-size: 12px; horizontal-alignment: center; wrap: word-wrap; }
                                            Rectangle {
                                                height: 36px; background: Theme.accent-teal; border-radius: 6px;
                                                Text { text: "Select"; color: Theme.sidebar-bg; font-size: 14px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                                TouchArea { clicked => { deploy-install-mode = 1; } }
                                            }
                                        }
                                    }
                                    // Automated Install card
                                    Rectangle {
                                        horizontal-stretch: 1;
                                        height: 180px;
                                        background: Theme.card-bg;
                                        border-radius: 12px;
                                        border-width: 2px;
                                        border-color: Theme.accent-blue;
                                        VerticalBox {
                                            padding: 20px;
                                            spacing: 10px;
                                            alignment: center;
                                            Text { text: "Automated Install"; color: Theme.accent-blue; font-size: 20px; font-weight: 700; horizontal-alignment: center; }
                                            Text { text: "Fully unattended — configure\nall settings, tweaks, and\nscripts in advance."; color: Theme.text-secondary; font-size: 12px; horizontal-alignment: center; wrap: word-wrap; }
                                            Rectangle {
                                                height: 36px; background: Theme.accent-blue; border-radius: 6px;
                                                Text { text: "Select"; color: white; font-size: 14px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                                TouchArea { clicked => { deploy-install-mode = 2; } }
                                            }
                                        }
                                    }
                                }
                            }

                            // ============================================
                            // NORMAL INSTALL PAGE (deploy-install-mode == 1)
                            // ============================================
                            if deploy-install-mode == 1: VerticalBox {
                                spacing: 16px;

                                // Back button
                                HorizontalBox {
                                    Rectangle {
                                        width: 80px; height: 32px; background: Theme.button-bg; border-radius: 6px;
                                        Text { text: "< Back"; color: Theme.text-primary; font-size: 12px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                        TouchArea { clicked => { deploy-install-mode = 0; } }
                                    }
                                    Text { text: "Normal Installation"; color: Theme.accent-teal; font-size: 16px; font-weight: 600; vertical-alignment: center; horizontal-stretch: 1; }
                                }

                                // IMAGE SELECTION (reuses same properties as automated)
                                Rectangle {
                                    background: Theme.card-bg;
                                    border-radius: 8px;
                                    height: normal-image-layout.preferred-height;
                                    normal-image-layout := VerticalBox {
                                        padding: 16px;
                                        spacing: 10px;
                                        HorizontalBox {
                                            spacing: 8px;
                                            Rectangle { width: 4px; height: 20px; background: Theme.accent-teal; border-radius: 2px; }
                                            Text { text: "IMAGE SELECTION"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                        }
                                        HorizontalBox {
                                            spacing: 12px;
                                            Text { text: "Image:"; color: Theme.text-secondary; font-size: 13px; vertical-alignment: center; width: 70px; }
                                            Rectangle {
                                                horizontal-stretch: 1; height: 32px; background: Theme.background-dark; border-radius: 6px;
                                                Text { x: 8px; text: deploy-wim-name != "" ? deploy-wim-name : "No image selected"; color: deploy-wim-name != "" ? Theme.text-primary : Theme.text-muted; font-size: 12px; vertical-alignment: center; overflow: elide; }
                                            }
                                            Rectangle {
                                                width: 80px; height: 32px; background: Theme.accent-teal; border-radius: 6px;
                                                Text { text: "Browse"; color: Theme.sidebar-bg; font-size: 12px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                                TouchArea { clicked => { deploy-browse-image(); } }
                                            }
                                        }
                                        if deploy-edition-list.length == 0 && deploy-wim-name != "": HorizontalBox {
                                            Rectangle {
                                                width: 120px; height: 32px; background: Theme.accent-teal; border-radius: 6px;
                                                Text { text: deploy-detecting ? "Scanning..." : "Scan Editions"; color: Theme.sidebar-bg; font-size: 12px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                                TouchArea { enabled: !deploy-detecting; clicked => { deploy-refresh-editions(); } }
                                            }
                                        }
                                        if deploy-edition-list.length > 0: HorizontalBox {
                                            spacing: 12px;
                                            Text { text: "Edition:"; color: Theme.text-secondary; font-size: 13px; vertical-alignment: center; width: 70px; }
                                            ComboBox {
                                                horizontal-stretch: 1;
                                                model: deploy-edition-list;
                                                current-value <=> deploy-selected-edition-name;
                                            }
                                        }
                                    }
                                }

                                // POST-INSTALL SCRIPTS (for normal install)
                                // Scripts are copied to C:\Temp\MasterBooter\ on the target drive
                                // and triggered via RunOnce registry key on first user logon.
                                Rectangle {
                                    background: Theme.card-bg;
                                    border-radius: 8px;
                                    height: normal-scripts-layout.preferred-height;
                                    normal-scripts-layout := VerticalBox {
                                        padding: 16px;
                                        spacing: 10px;
                                        HorizontalBox {
                                            spacing: 8px;
                                            Rectangle { width: 4px; height: 20px; background: Theme.accent-teal; border-radius: 2px; }
                                            Text { text: "POST-INSTALL SCRIPTS"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                        }
                                        Text { text: "Scripts run automatically after the first user logs into the new Windows. Output is logged to C:\\Temp\\MasterBooter\\RunAll.log"; color: Theme.text-muted; font-size: 11px; wrap: word-wrap; }

                                        // FirstLogon scripts — add/view list
                                        HorizontalBox {
                                            spacing: 8px;
                                            Text { text: "Scripts:"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; vertical-alignment: center; horizontal-stretch: 1; }
                                            Rectangle {
                                                width: 50px; height: 28px; background: Theme.accent-teal; border-radius: 4px;
                                                Text { text: "Add"; color: Theme.sidebar-bg; font-size: 11px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                                TouchArea { clicked => { deploy-add-firstlogon-script(); } }
                                            }
                                        }
                                        if deploy-firstlogon-scripts != "": Text { text: deploy-firstlogon-scripts; color: Theme.text-primary; font-size: 11px; wrap: word-wrap; }
                                        if deploy-firstlogon-scripts == "": Text { text: "No scripts added"; color: Theme.text-muted; font-size: 11px; }
                                    }
                                }

                                // START NORMAL INSTALL button + progress
                                Rectangle {
                                    background: Theme.card-bg;
                                    border-radius: 8px;
                                    height: deploy-building ? 100px : 60px;
                                    VerticalBox {
                                        padding: 12px;
                                        spacing: 8px;
                                        HorizontalBox {
                                            spacing: 12px;
                                            Rectangle { horizontal-stretch: 1; }
                                            Rectangle {
                                                width: 200px; height: 36px;
                                                background: deploy-building ? Theme.text-muted : Theme.accent-teal;
                                                border-radius: 6px;
                                                opacity: deploy-building ? 0.6 : 1.0;
                                                Text {
                                                    text: deploy-building ? "Installing..." : "Start Normal Install";
                                                    color: Theme.sidebar-bg;
                                                    font-size: 14px; font-weight: 700;
                                                    horizontal-alignment: center; vertical-alignment: center;
                                                }
                                                TouchArea { enabled: !deploy-building; clicked => { deploy-start-normal(); } }
                                            }
                                        }
                                        if deploy-building: Rectangle {
                                            height: 24px; background: Theme.background-dark; border-radius: 4px;
                                            Rectangle { x: 0; width: parent.width * (deploy-build-progress / 100); height: parent.height; background: Theme.accent-teal; border-radius: 4px; }
                                            Text { text: deploy-build-status != "" ? deploy-build-status : deploy-build-progress + "%"; color: Theme.text-primary; font-size: 11px; horizontal-alignment: center; vertical-alignment: center; }
                                        }
                                    }
                                }
                            }

                            // ============================================
                            // AUTOMATED INSTALL PAGE (deploy-install-mode == 2)
                            // ============================================
                            if deploy-install-mode == 2: VerticalBox {
                                spacing: 16px;

                                // Back button
                                HorizontalBox {
                                    Rectangle {
                                        width: 80px; height: 32px; background: Theme.button-bg; border-radius: 6px;
                                        Text { text: "< Back"; color: Theme.text-primary; font-size: 12px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                        TouchArea { clicked => { deploy-install-mode = 0; } }
                                    }
                                    Text { text: "Automated Installation"; color: Theme.accent-blue; font-size: 16px; font-weight: 600; vertical-alignment: center; horizontal-stretch: 1; }
                                }
                            }

                            // ============================================
                            // AUTOMATED INSTALL CONTENT (only visible when mode == 2)
                            // All existing sections below are for automated mode
                            // ============================================
                            if deploy-install-mode == 2: VerticalBox {
                                spacing: 16px;

                            // ============================================
                            // PROFILES (at top for quick access)
                            // ============================================
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: profiles-layout.preferred-height;
                                profiles-layout := VerticalBox {
                                    padding: 16px;
                                    spacing: 10px;
                                    // Section header
                                    HorizontalBox {
                                        spacing: 8px;
                                        Rectangle { width: 4px; height: 20px; background: Theme.accent-teal; border-radius: 2px; }
                                        Text { text: "PROFILES"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                    }

                                    // Row 1: ComboBox dropdown to select saved profiles (auto-loads on select)
                                    HorizontalBox {
                                        spacing: 8px;
                                        ComboBox {
                                            horizontal-stretch: 1;
                                            model: deploy-profile-list;
                                            current-value <=> deploy-active-profile;
                                            // When user selects a profile from dropdown, auto-load it
                                            selected(value) => { deploy-select-profile(value); }
                                        }
                                        // Delete button — removes the currently selected profile
                                        Rectangle {
                                            width: 70px; height: 32px; background: #5c2020; border-radius: 6px;
                                            Text { text: "Delete"; color: #ff6b6b; font-size: 12px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { deploy-delete-profile(deploy-active-profile); } }
                                        }
                                    }

                                    // Row 2: Save new profile (type name + Save) and Import from file
                                    HorizontalBox {
                                        spacing: 8px;
                                        LineEdit { text <=> deploy-profile-name-input; horizontal-stretch: 1; placeholder-text: "New profile name..."; }
                                        Rectangle {
                                            width: 60px; height: 32px; background: Theme.accent-teal; border-radius: 6px;
                                            Text { text: "Save"; color: Theme.sidebar-bg; font-size: 12px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { deploy-save-profile(deploy-profile-name-input); } }
                                        }
                                        Rectangle {
                                            width: 70px; height: 32px; background: Theme.button-bg; border-radius: 6px;
                                            Text { text: "Import"; color: Theme.text-primary; font-size: 12px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { deploy-import-profile(); } }
                                        }
                                    }
                                }
                            }

                            // ============================================
                            // IMAGE SELECTION
                            // ============================================
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: image-layout.preferred-height;
                                image-layout := VerticalBox {
                                    padding: 16px;
                                    spacing: 10px;
                                    // Section header
                                    HorizontalBox {
                                        spacing: 8px;
                                        Rectangle { width: 4px; height: 20px; background: Theme.accent-blue; border-radius: 2px; }
                                        Text { text: "IMAGE SELECTION"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                    }
                                    // Browse for image file
                                    HorizontalBox {
                                        spacing: 12px;
                                        Text { text: "Image:"; color: Theme.text-secondary; font-size: 13px; vertical-alignment: center; width: 70px; }
                                        Rectangle {
                                            horizontal-stretch: 1; height: 32px; background: Theme.background-dark; border-radius: 6px;
                                            Text { x: 8px; text: deploy-wim-name != "" ? deploy-wim-name : "No image selected"; color: deploy-wim-name != "" ? Theme.text-primary : Theme.text-muted; font-size: 12px; vertical-alignment: center; overflow: elide; }
                                        }
                                        Rectangle {
                                            width: 80px; height: 32px; background: Theme.accent-blue; border-radius: 6px;
                                            Text { text: "Browse"; color: white; font-size: 12px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { deploy-browse-image(); } }
                                        }
                                    }
                                    // Scan editions button (only shows when image is selected but no editions scanned yet)
                                    if deploy-edition-list.length == 0 && deploy-wim-name != "": HorizontalBox {
                                        Rectangle {
                                            width: 120px; height: 32px; background: Theme.accent-teal; border-radius: 6px;
                                            Text { text: deploy-detecting ? "Scanning..." : "Scan Editions"; color: Theme.sidebar-bg; font-size: 12px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { enabled: !deploy-detecting; clicked => { deploy-refresh-editions(); } }
                                        }
                                    }
                                    // Edition dropdown (shows after scanning)
                                    if deploy-edition-list.length > 0: HorizontalBox {
                                        spacing: 12px;
                                        Text { text: "Edition:"; color: Theme.text-secondary; font-size: 13px; vertical-alignment: center; width: 70px; }
                                        ComboBox {
                                            horizontal-stretch: 1;
                                            model: deploy-edition-list;
                                            current-value <=> deploy-selected-edition-name;
                                        }
                                    }
                                }
                            }

                            // ============================================
                            // DISK SELECTION
                            // ============================================
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: disk-layout.preferred-height;
                                disk-layout := VerticalBox {
                                    padding: 16px;
                                    spacing: 10px;
                                    // Section header
                                    HorizontalBox {
                                        spacing: 8px;
                                        Rectangle { width: 4px; height: 20px; background: Theme.accent-blue; border-radius: 2px; }
                                        Text { text: "DISK SELECTION"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                    }
                                    PECheckbox { checked <=> deploy-let-windows-choose; label: "Let Windows choose target disk"; description: "Windows Setup will prompt for disk selection"; }
                                    // Boot mode toggle
                                    HorizontalBox {
                                        spacing: 8px;
                                        Text { text: "Boot Mode:"; color: Theme.text-secondary; font-size: 13px; vertical-alignment: center; width: 100px; }
                                        Rectangle {
                                            width: 80px; height: 32px;
                                            background: deploy-boot-mode == "UEFI" ? Theme.accent-teal : Theme.button-bg; border-radius: 6px;
                                            Text { text: "UEFI"; color: deploy-boot-mode == "UEFI" ? Theme.sidebar-bg : Theme.text-primary; font-size: 12px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { deploy-boot-mode = "UEFI"; } }
                                        }
                                        Rectangle {
                                            width: 80px; height: 32px;
                                            background: deploy-boot-mode == "BIOS" ? Theme.accent-teal : Theme.button-bg; border-radius: 6px;
                                            Text { text: "BIOS"; color: deploy-boot-mode == "BIOS" ? Theme.sidebar-bg : Theme.text-primary; font-size: 12px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { deploy-boot-mode = "BIOS"; } }
                                        }
                                    }
                                    // Scan disks button + disk dropdown
                                    if !deploy-let-windows-choose: HorizontalBox {
                                        spacing: 12px;
                                        Text { text: "Disk:"; color: Theme.text-secondary; font-size: 13px; vertical-alignment: center; width: 70px; }
                                        ComboBox {
                                            horizontal-stretch: 1;
                                            model: deploy-disk-list;
                                            current-value <=> deploy-selected-disk-name;
                                        }
                                        Rectangle {
                                            width: 80px; height: 32px; background: Theme.button-bg; border-radius: 6px;
                                            Text { text: "Scan"; color: Theme.text-primary; font-size: 12px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { deploy-refresh-disks(); } }
                                        }
                                    }
                                }
                            }

                            // ============================================
                            // MACHINE & USER
                            // ============================================
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: user-layout.preferred-height;
                                user-layout := VerticalBox {
                                    padding: 16px;
                                    spacing: 8px;
                                    HorizontalBox {
                                        spacing: 8px;
                                        Rectangle { width: 4px; height: 20px; background: Theme.accent-teal; border-radius: 2px; }
                                        Text { text: "MACHINE & USER"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                    }
                                    HorizontalBox {
                                        spacing: 12px;
                                        Text { text: "Computer Name:"; color: Theme.text-secondary; font-size: 13px; vertical-alignment: center; width: 120px; }
                                        LineEdit { text <=> deploy-computer-name; horizontal-stretch: 1; placeholder-text: "* = auto-generate"; }
                                    }
                                    HorizontalBox {
                                        spacing: 12px;
                                        Text { text: "Username:"; color: Theme.text-secondary; font-size: 13px; vertical-alignment: center; width: 120px; }
                                        LineEdit { text <=> deploy-user-name; horizontal-stretch: 1; placeholder-text: "Admin"; }
                                    }
                                    HorizontalBox {
                                        spacing: 12px;
                                        Text { text: "Password:"; color: Theme.text-secondary; font-size: 13px; vertical-alignment: center; width: 120px; }
                                        LineEdit { text <=> deploy-user-password; horizontal-stretch: 1; input-type: password; placeholder-text: "Leave empty for no password"; }
                                    }
                                    HorizontalBox {
                                        spacing: 12px;
                                        Text { text: "Display Name:"; color: Theme.text-secondary; font-size: 13px; vertical-alignment: center; width: 120px; }
                                        LineEdit { text <=> deploy-user-display-name; horizontal-stretch: 1; placeholder-text: "Administrator"; }
                                    }
                                    HorizontalBox {
                                        spacing: 16px;
                                        PECheckbox { checked <=> deploy-user-is-admin; label: "Administrator account"; }
                                        PECheckbox { checked <=> deploy-enable-autologon; label: "Auto-logon"; }
                                    }
                                }
                            }

                            // ============================================
                            // OOBE & SETUP OPTIONS
                            // ============================================
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: oobe-layout.preferred-height;
                                oobe-layout := VerticalBox {
                                    padding: 16px;
                                    spacing: 10px;
                                    HorizontalBox {
                                        spacing: 8px;
                                        Rectangle { width: 4px; height: 20px; background: Theme.accent-teal; border-radius: 2px; }
                                        Text { text: "OOBE & SETUP"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                    }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-skip-oobe; label: "Skip OOBE"; } PECheckbox { checked <=> deploy-skip-eula; label: "Skip EULA"; } }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-skip-network; label: "Skip network setup"; } PECheckbox { checked <=> deploy-bypass-win11; label: "Bypass Win11 requirements"; } }

                                    // Product Key + Registration
                                    HorizontalBox {
                                        spacing: 8px;
                                        Text { text: "Product Key:"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; vertical-alignment: center; width: 90px; }
                                        LineEdit {
                                            horizontal-stretch: 1;
                                            text <=> deploy-product-key;
                                            placeholder-text: "Leave empty for generic key (selects edition only)";
                                            font-size: 12px;
                                        }
                                    }
                                    // Saved keys row: ComboBox dropdown + Load + Delete buttons
                                    // IT pros service multiple machines — this lets them pick which
                                    // machine's key to load into the product key field above.
                                    HorizontalBox {
                                        spacing: 8px;
                                        Text { text: "Saved Keys:"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; vertical-alignment: center; width: 90px; }
                                        ComboBox {
                                            horizontal-stretch: 1;
                                            model: deploy-saved-key-labels;
                                            current-index <=> deploy-saved-key-index;
                                            // Note: no action on select — user clicks Load to apply
                                        }
                                        // Load button — fills the product key field from the selected entry
                                        Rectangle {
                                            width: 55px; height: 28px; background: Theme.accent-blue; border-radius: 4px;
                                            Text { text: "Load"; color: white; font-size: 10px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { deploy-load-saved-key-at(deploy-saved-key-index); } }
                                        }
                                        // Delete button — removes the selected entry from saved_keys.json
                                        Rectangle {
                                            width: 55px; height: 28px; background: Theme.accent-red; border-radius: 4px;
                                            Text { text: "Delete"; color: white; font-size: 10px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { deploy-delete-saved-key(deploy-saved-key-index); } }
                                        }
                                    }
                                    HorizontalBox {
                                        spacing: 8px;
                                        Text { text: "Organization:"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; vertical-alignment: center; width: 90px; }
                                        LineEdit { horizontal-stretch: 1; text <=> deploy-organization; placeholder-text: "Optional"; font-size: 12px; }
                                    }
                                    HorizontalBox {
                                        spacing: 8px;
                                        Text { text: "Owner Name:"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; vertical-alignment: center; width: 90px; }
                                        LineEdit { horizontal-stretch: 1; text <=> deploy-owner-name; placeholder-text: "Optional"; font-size: 12px; }
                                    }
                                    // Hint about generic keys
                                    if deploy-product-key == "" && deploy-selected-edition-name != "": Text {
                                        text: "No key provided — a generic key will be used to install " + deploy-selected-edition-name + " (activate later)";
                                        color: Theme.text-muted;
                                        font-size: 10px;
                                        wrap: word-wrap;
                                    }
                                }
                            }

                            // ============================================
                            // PRIVACY TWEAKS
                            // ============================================
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: privacy-layout.preferred-height;
                                privacy-layout := VerticalBox {
                                    padding: 16px;
                                    spacing: 8px;
                                    HorizontalBox {
                                        spacing: 8px;
                                        Rectangle { width: 4px; height: 20px; background: Theme.accent-orange; border-radius: 2px; }
                                        Text { text: "PRIVACY"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                    }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-disable-telemetry; label: "Disable telemetry"; } PECheckbox { checked <=> deploy-disable-location; label: "Disable location tracking"; } }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-disable-ads; label: "Disable advertising ID"; } PECheckbox { checked <=> deploy-disable-suggested-apps; label: "Disable suggested apps"; } }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-disable-bing-search; label: "Disable Bing search"; } PECheckbox { checked <=> deploy-disable-smartscreen; label: "Disable SmartScreen"; } }
                                }
                            }

                            // ============================================
                            // SECURITY TWEAKS
                            // ============================================
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: security-layout.preferred-height;
                                security-layout := VerticalBox {
                                    padding: 16px;
                                    spacing: 8px;
                                    HorizontalBox {
                                        spacing: 8px;
                                        Rectangle { width: 4px; height: 20px; background: Theme.accent-red; border-radius: 2px; }
                                        Text { text: "SECURITY"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                    }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-enable-rdp; label: "Enable Remote Desktop"; } PECheckbox { checked <=> deploy-disable-uac; label: "Disable UAC prompts"; } }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-disable-defender; label: "Disable Windows Defender"; } PECheckbox { checked <=> deploy-disable-firewall; label: "Disable Windows Firewall"; } }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-disable-vbs; label: "Disable Core Isolation (VBS)"; } PECheckbox { checked <=> deploy-disable-bitlocker; label: "Disable BitLocker auto-encrypt"; } }
                                }
                            }

                            // ============================================
                            // PERFORMANCE TWEAKS
                            // ============================================
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: perf-layout.preferred-height;
                                perf-layout := VerticalBox {
                                    padding: 16px;
                                    spacing: 8px;
                                    HorizontalBox {
                                        spacing: 8px;
                                        Rectangle { width: 4px; height: 20px; background: Theme.accent-teal; border-radius: 2px; }
                                        Text { text: "PERFORMANCE"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                    }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-disable-fast-startup; label: "Disable Fast Startup"; } PECheckbox { checked <=> deploy-high-performance; label: "High Performance power plan"; } }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-disable-system-restore; label: "Disable System Restore"; } }
                                }
                            }

                            // ============================================
                            // UI CUSTOMIZATION
                            // ============================================
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: ui-layout.preferred-height;
                                ui-layout := VerticalBox {
                                    padding: 16px;
                                    spacing: 8px;
                                    HorizontalBox {
                                        spacing: 8px;
                                        Rectangle { width: 4px; height: 20px; background: Theme.accent-blue; border-radius: 2px; }
                                        Text { text: "UI CUSTOMIZATION"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                    }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-show-file-extensions; label: "Show file extensions"; } PECheckbox { checked <=> deploy-show-hidden-files; label: "Show hidden files"; } }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-classic-context-menu; label: "Classic right-click menu"; } PECheckbox { checked <=> deploy-hide-task-view; label: "Hide Task View button"; } }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-hide-widgets; label: "Hide Widgets button"; } PECheckbox { checked <=> deploy-taskbar-left-align; label: "Left-align taskbar (Win11)"; } }
                                }
                            }

                            // ============================================
                            // BLOATWARE REMOVAL
                            // ============================================
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: bloat-layout.preferred-height;
                                bloat-layout := VerticalBox {
                                    padding: 16px;
                                    spacing: 8px;
                                    HorizontalBox {
                                        spacing: 8px;
                                        Rectangle { width: 4px; height: 20px; background: Theme.accent-orange; border-radius: 2px; }
                                        Text { text: "BLOATWARE REMOVAL"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                    }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-disable-cortana; label: "Disable Cortana"; } PECheckbox { checked <=> deploy-disable-onedrive; label: "Disable OneDrive"; } }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-disable-teams; label: "Disable Teams chat"; } PECheckbox { checked <=> deploy-disable-copilot; label: "Disable Copilot"; } }
                                    HorizontalBox { spacing: 16px; PECheckbox { checked <=> deploy-disable-widgets-service; label: "Disable Widgets service"; } }
                                }
                            }

                            // ============================================
                            // DOMAIN JOIN
                            // ============================================
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: domain-layout.preferred-height;
                                domain-layout := VerticalBox {
                                    padding: 16px;
                                    spacing: 8px;
                                    HorizontalBox {
                                        spacing: 8px;
                                        Rectangle { width: 4px; height: 20px; background: Theme.accent-blue; border-radius: 2px; }
                                        Text { text: "DOMAIN JOIN"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                    }
                                    PECheckbox { checked <=> deploy-join-domain; label: "Join a domain"; description: "Enterprise Active Directory domain join"; }
                                    if deploy-join-domain: VerticalBox {
                                        spacing: 8px;
                                        HorizontalBox { spacing: 12px; Text { text: "Domain:"; color: Theme.text-secondary; font-size: 13px; vertical-alignment: center; width: 120px; } LineEdit { text <=> deploy-domain-name; horizontal-stretch: 1; placeholder-text: "contoso.com"; } }
                                        HorizontalBox { spacing: 12px; Text { text: "Username:"; color: Theme.text-secondary; font-size: 13px; vertical-alignment: center; width: 120px; } LineEdit { text <=> deploy-domain-username; horizontal-stretch: 1; placeholder-text: "DOMAIN\\Administrator"; } }
                                        HorizontalBox { spacing: 12px; Text { text: "Password:"; color: Theme.text-secondary; font-size: 13px; vertical-alignment: center; width: 120px; } LineEdit { text <=> deploy-domain-password; horizontal-stretch: 1; input-type: password; } }
                                    }
                                }
                            }

                            // ============================================
                            // POST-INSTALL SCRIPTS
                            // ============================================
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: auto-scripts-layout.preferred-height;
                                auto-scripts-layout := VerticalBox {
                                    padding: 16px;
                                    spacing: 10px;
                                    HorizontalBox {
                                        spacing: 8px;
                                        Rectangle { width: 4px; height: 20px; background: Theme.accent-blue; border-radius: 2px; }
                                        Text { text: "POST-INSTALL SCRIPTS"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; vertical-alignment: center; }
                                    }
                                    Text { text: "Scripts run automatically after the first user logs into the new Windows. They are called from the autounattend.xml FirstLogonCommands. Output is logged to C:\\Temp\\MasterBooter\\RunAll.log"; color: Theme.text-muted; font-size: 11px; wrap: word-wrap; }

                                    // FirstLogon scripts — add/view list
                                    HorizontalBox {
                                        spacing: 8px;
                                        Text { text: "Scripts:"; color: Theme.text-secondary; font-size: 12px; font-weight: 600; vertical-alignment: center; horizontal-stretch: 1; }
                                        Rectangle {
                                            width: 50px; height: 28px; background: Theme.accent-blue; border-radius: 4px;
                                            Text { text: "Add"; color: white; font-size: 11px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { deploy-add-firstlogon-script(); } }
                                        }
                                    }
                                    if deploy-firstlogon-scripts != "": Text { text: deploy-firstlogon-scripts; color: Theme.text-primary; font-size: 11px; wrap: word-wrap; }
                                    if deploy-firstlogon-scripts == "": Text { text: "No scripts added"; color: Theme.text-muted; font-size: 11px; }
                                }
                            }

                            // ============================================
                            // ACTION BAR
                            // ============================================
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                height: deploy-building ? 100px : 60px;

                                VerticalBox {
                                    padding: 12px;
                                    spacing: 8px;

                                    HorizontalBox {
                                        spacing: 12px;

                                        // Preview XML button
                                        Rectangle {
                                            width: 120px; height: 36px;
                                            background: Theme.button-bg;
                                            border-radius: 6px;
                                            Text { text: "Preview XML"; color: Theme.text-primary; font-size: 13px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; }
                                            TouchArea { clicked => { deploy-preview-xml(); } }
                                        }

                                        // Spacer
                                        Rectangle { horizontal-stretch: 1; }

                                        // Deploy button
                                        Rectangle {
                                            width: 180px; height: 36px;
                                            background: deploy-building ? Theme.text-muted : Theme.accent-blue;
                                            border-radius: 6px;
                                            opacity: deploy-building ? 0.6 : 1.0;
                                            Text {
                                                text: deploy-building ? "Deploying..." : "Deploy Windows";
                                                color: white;
                                                font-size: 14px;
                                                font-weight: 700;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                            }
                                            TouchArea {
                                                enabled: !deploy-building;
                                                clicked => { deploy-start(); }
                                            }
                                        }
                                    }

                                    // Progress bar (shown during deployment)
                                    if deploy-building: Rectangle {
                                        height: 24px;
                                        background: Theme.background-dark;
                                        border-radius: 4px;

                                        Rectangle {
                                            x: 0;
                                            width: parent.width * (deploy-build-progress / 100);
                                            height: parent.height;
                                            background: Theme.accent-teal;
                                            border-radius: 4px;
                                        }

                                        Text {
                                            text: deploy-build-status != "" ? deploy-build-status : deploy-build-progress + "%";
                                            color: Theme.text-primary;
                                            font-size: 11px;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                            }
                            } // close: if deploy-install-mode == 2 VerticalBox
                        }

                        // ============================
                        // WINPE BUILDER VIEW
                        // ============================
                        if current-mode == 2: VerticalBox {
                            spacing: 20px;

                            // Header
                            Text {
                                text: "WinPE Builder";
                                color: Theme.text-primary;
                                font-size: 28px;
                                font-weight: 700;
                            }
                            Text {
                                text: "Create a bootable Windows PE/RE recovery environment for deployment and troubleshooting.";
                                color: Theme.text-secondary;
                                font-size: 14px;
                            }

                            // ========================================
                            // SYSTEM DETECTION SECTION
                            // ========================================
                            SectionHeader { text: "SYSTEM DETECTION"; }

                            Rectangle {
                                height: 120px;
                                background: Theme.card-bg;
                                border-radius: 8px;

                                HorizontalBox {
                                    padding: 20px;
                                    spacing: 30px;

                                    // WinRE Status
                                    VerticalBox {
                                        spacing: 8px;
                                        horizontal-stretch: 1;

                                        HorizontalBox {
                                            spacing: 8px;

                                            Rectangle {
                                                width: 12px;
                                                height: 12px;
                                                border-radius: 6px;
                                                background: winre-found ? Theme.accent-green : Theme.accent-yellow;
                                                y: 4px;
                                            }

                                            Text {
                                                text: "Windows Recovery Environment";
                                                color: Theme.text-primary;
                                                font-size: 14px;
                                                font-weight: 600;
                                            }
                                        }

                                        Text {
                                            text: winre-found ? winre-path : "Not detected - Click 'Detect' to scan";
                                            color: Theme.text-secondary;
                                            font-size: 12px;
                                            overflow: elide;
                                        }

                                        Text {
                                            text: winre-found ? "Size: " + winre-size : "WinRE is typically located in C:\\Windows\\System32\\Recovery";
                                            color: Theme.text-muted;
                                            font-size: 11px;
                                        }
                                    }

                                    // ADK Status
                                    VerticalBox {
                                        spacing: 8px;
                                        horizontal-stretch: 1;

                                        HorizontalBox {
                                            spacing: 8px;

                                            Rectangle {
                                                width: 12px;
                                                height: 12px;
                                                border-radius: 6px;
                                                background: adk-found ? Theme.accent-green : Theme.text-muted;
                                                y: 4px;
                                            }

                                            Text {
                                                text: "Windows ADK";
                                                color: Theme.text-primary;
                                                font-size: 14px;
                                                font-weight: 600;
                                            }
                                        }

                                        Text {
                                            text: adk-found ? adk-version : "Not installed (optional)";
                                            color: Theme.text-secondary;
                                            font-size: 12px;
                                        }

                                        Text {
                                            text: adk-found ? "Advanced WinPE customization available" : "Enables advanced package installation";
                                            color: Theme.text-muted;
                                            font-size: 11px;
                                        }
                                    }

                                    // Buttons row
                                    HorizontalBox {
                                        spacing: 10px;
                                        y: 20px;

                                        // Detect button — shows "Detecting..." and greys out while detection runs
                                        Rectangle {
                                            width: pe-detecting ? 120px : 100px;
                                            height: 36px;
                                            background: pe-detecting ? Theme.button-bg : Theme.accent-blue;
                                            border-radius: 6px;

                                            Text {
                                                text: pe-detecting ? "Detecting..." : "Detect";
                                                color: pe-detecting ? Theme.text-muted : Theme.sidebar-bg;
                                                font-size: 13px;
                                                font-weight: 600;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                            }

                                            TouchArea {
                                                enabled: !pe-detecting;
                                                clicked => { pe-detect-winre(); }
                                            }
                                        }

                                        // Install Dependencies button - only show when dependencies are missing
                                        Rectangle {
                                            width: 160px;
                                            height: 36px;
                                            background: all-deps-satisfied ? Theme.button-bg : Theme.accent-orange;
                                            border-radius: 6px;
                                            visible: !all-deps-satisfied;

                                            Text {
                                                text: "Install Dependencies";
                                                color: Theme.text-primary;
                                                font-size: 13px;
                                                font-weight: 600;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                            }

                                            TouchArea {
                                                clicked => { pe-install-adk(); }
                                            }
                                        }
                                    }
                                }
                            }

                            // ========================================
                            // BUILD CONFIGURATION SECTION
                            // ========================================
                            SectionHeader { text: "BUILD CONFIGURATION"; }

                            Rectangle {
                                height: 300px;
                                background: Theme.card-bg;
                                border-radius: 8px;

                                VerticalBox {
                                    padding: 20px;
                                    spacing: 15px;

                                    // Source selection - three options
                                    VerticalBox {
                                        spacing: 8px;

                                        Text {
                                            text: "Select Build Source:";
                                            color: Theme.text-secondary;
                                            font-size: 13px;
                                            font-weight: 600;
                                        }

                                        HorizontalBox {
                                            spacing: 10px;

                                            // Option 1: Local Recovery
                                            Rectangle {
                                                width: 160px;
                                                height: 60px;
                                                background: pe-source == "LocalRE" ? Theme.accent-teal : Theme.button-bg;
                                                border-radius: 6px;

                                                VerticalBox {
                                                    padding: 8px;
                                                    spacing: 2px;

                                                    Text {
                                                        text: "Local Recovery";
                                                        color: pe-source == "LocalRE" ? Theme.sidebar-bg : Theme.text-primary;
                                                        font-size: 12px;
                                                        font-weight: 600;
                                                        horizontal-alignment: center;
                                                    }
                                                    Text {
                                                        text: winre-found ? "✓ Found" : "Not detected";
                                                        color: pe-source == "LocalRE" ? Theme.sidebar-bg : (winre-found ? Theme.accent-green : Theme.text-muted);
                                                        font-size: 10px;
                                                        horizontal-alignment: center;
                                                    }
                                                    Text {
                                                        text: "System WinRE.wim";
                                                        color: pe-source == "LocalRE" ? Theme.sidebar-bg : Theme.text-muted;
                                                        font-size: 9px;
                                                        horizontal-alignment: center;
                                                    }
                                                }

                                                TouchArea {
                                                    clicked => {
                                                        if (winre-found) {
                                                            pe-source = "LocalRE";
                                                        } else {
                                                            pe-detect-winre();
                                                        }
                                                    }
                                                }
                                            }

                                            // Option 2: ISO for WinPE (deployment)
                                            Rectangle {
                                                width: 160px;
                                                height: 60px;
                                                background: pe-source == "ISO_PE" ? Theme.accent-orange : Theme.button-bg;
                                                border-radius: 6px;

                                                VerticalBox {
                                                    padding: 8px;
                                                    spacing: 2px;

                                                    Text {
                                                        text: "ISO → WinPE";
                                                        color: pe-source == "ISO_PE" ? Theme.sidebar-bg : Theme.text-primary;
                                                        font-size: 12px;
                                                        font-weight: 600;
                                                        horizontal-alignment: center;
                                                    }
                                                    Text {
                                                        text: iso-selected ? "✓ ISO Selected" : "Click to select";
                                                        color: pe-source == "ISO_PE" ? Theme.sidebar-bg : (iso-selected ? Theme.accent-green : Theme.text-muted);
                                                        font-size: 10px;
                                                        horizontal-alignment: center;
                                                    }
                                                    Text {
                                                        text: "Deployment env";
                                                        color: pe-source == "ISO_PE" ? Theme.sidebar-bg : Theme.text-muted;
                                                        font-size: 9px;
                                                        horizontal-alignment: center;
                                                    }
                                                }

                                                TouchArea {
                                                    clicked => {
                                                        pe-source = "ISO_PE";
                                                        pe-browse-source();
                                                    }
                                                }
                                            }

                                            // Option 3: ISO for WinRE (recovery)
                                            Rectangle {
                                                width: 160px;
                                                height: 60px;
                                                background: pe-source == "ISO_RE" ? Theme.accent-blue : Theme.button-bg;
                                                border-radius: 6px;

                                                VerticalBox {
                                                    padding: 8px;
                                                    spacing: 2px;

                                                    Text {
                                                        text: "ISO → WinRE";
                                                        color: pe-source == "ISO_RE" ? Theme.sidebar-bg : Theme.text-primary;
                                                        font-size: 12px;
                                                        font-weight: 600;
                                                        horizontal-alignment: center;
                                                    }
                                                    Text {
                                                        text: iso-selected ? "✓ ISO Selected" : "Click to select";
                                                        color: pe-source == "ISO_RE" ? Theme.sidebar-bg : (iso-selected ? Theme.accent-green : Theme.text-muted);
                                                        font-size: 10px;
                                                        horizontal-alignment: center;
                                                    }
                                                    Text {
                                                        text: "Recovery tools";
                                                        color: pe-source == "ISO_RE" ? Theme.sidebar-bg : Theme.text-muted;
                                                        font-size: 9px;
                                                        horizontal-alignment: center;
                                                    }
                                                }

                                                TouchArea {
                                                    clicked => {
                                                        pe-source = "ISO_RE";
                                                        pe-browse-source();
                                                    }
                                                }
                                            }

                                            Rectangle { horizontal-stretch: 1; }
                                        }

                                        // Show selected source path
                                        Text {
                                            text: pe-source == "LocalRE" ? (winre-found ? "Source: " + winre-path : "Click 'Detect' in System Detection above") :
                                                  (iso-selected ? "Source: " + iso-path : "No ISO selected");
                                            color: Theme.text-muted;
                                            font-size: 11px;
                                            overflow: elide;
                                        }
                                    }

                                    // Output type selection (only for ISO modes)
                                    if pe-source != "LocalRE": HorizontalBox {
                                        spacing: 12px;

                                        Text {
                                            text: "Output Type:";
                                            color: Theme.text-secondary;
                                            font-size: 13px;
                                            vertical-alignment: center;
                                            width: 120px;
                                        }

                                        // ISO button
                                        Rectangle {
                                            width: 60px;
                                            height: 28px;
                                            background: pe-output-type == "ISO" ? Theme.accent-teal : Theme.button-bg;
                                            border-radius: 4px;
                                            Text {
                                                text: "ISO";
                                                color: pe-output-type == "ISO" ? Theme.sidebar-bg : Theme.text-primary;
                                                font-size: 11px;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                            }
                                            TouchArea { clicked => { pe-output-type = "ISO"; } }
                                        }

                                        // USB button
                                        Rectangle {
                                            width: 60px;
                                            height: 28px;
                                            background: pe-output-type == "USB" ? Theme.accent-teal : Theme.button-bg;
                                            border-radius: 4px;
                                            Text {
                                                text: "USB";
                                                color: pe-output-type == "USB" ? Theme.sidebar-bg : Theme.text-primary;
                                                font-size: 11px;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                            }
                                            TouchArea { clicked => { pe-output-type = "USB"; } }
                                        }

                                        // VHD button
                                        Rectangle {
                                            width: 60px;
                                            height: 28px;
                                            background: pe-output-type == "VHD" ? Theme.accent-teal : Theme.button-bg;
                                            border-radius: 4px;
                                            Text {
                                                text: "VHD";
                                                color: pe-output-type == "VHD" ? Theme.sidebar-bg : Theme.text-primary;
                                                font-size: 11px;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                            }
                                            TouchArea { clicked => { pe-output-type = "VHD"; } }
                                        }

                                        Rectangle { horizontal-stretch: 1; }

                                        // UEFI 2023 CA checkbox
                                        HorizontalBox {
                                            spacing: 6px;
                                            Rectangle {
                                                width: 18px;
                                                height: 18px;
                                                background: pe-use-uefi-2023-ca ? Theme.accent-teal : Theme.button-bg;
                                                border-radius: 4px;
                                                Text {
                                                    text: pe-use-uefi-2023-ca ? "✓" : "";
                                                    color: Theme.sidebar-bg;
                                                    font-size: 12px;
                                                    horizontal-alignment: center;
                                                    vertical-alignment: center;
                                                }
                                                TouchArea { clicked => { pe-use-uefi-2023-ca = !pe-use-uefi-2023-ca; } }
                                            }
                                            Text {
                                                text: "UEFI 2023 CA";
                                                color: Theme.text-primary;
                                                font-size: 11px;
                                                vertical-alignment: center;
                                            }
                                        }
                                    }

                                    // Backup original (only for Local RE mode)
                                    if pe-source == "LocalRE": HorizontalBox {
                                        spacing: 12px;

                                        Text {
                                            text: "Options:";
                                            color: Theme.text-secondary;
                                            font-size: 13px;
                                            vertical-alignment: center;
                                            width: 120px;
                                        }

                                        HorizontalBox {
                                            spacing: 6px;
                                            Rectangle {
                                                width: 18px;
                                                height: 18px;
                                                background: pe-backup-original ? Theme.accent-teal : Theme.button-bg;
                                                border-radius: 4px;
                                                Text {
                                                    text: pe-backup-original ? "✓" : "";
                                                    color: Theme.sidebar-bg;
                                                    font-size: 12px;
                                                    horizontal-alignment: center;
                                                    vertical-alignment: center;
                                                }
                                                TouchArea { clicked => { pe-backup-original = !pe-backup-original; } }
                                            }
                                            Text {
                                                text: "Backup original WinRE before modifying";
                                                color: Theme.text-primary;
                                                font-size: 12px;
                                                vertical-alignment: center;
                                            }
                                        }

                                        Rectangle { horizontal-stretch: 1; }
                                    }

                                    // Output path
                                    HorizontalBox {
                                        spacing: 12px;

                                        Text {
                                            text: pe-source == "LocalRE" ? "Output WIM:" :
                                                  (pe-output-type == "USB" ? "Target Drive:" : "Output Path:");
                                            color: Theme.text-secondary;
                                            font-size: 13px;
                                            vertical-alignment: center;
                                            width: 120px;
                                        }

                                        Rectangle {
                                            horizontal-stretch: 1;
                                            height: 32px;
                                            background: Theme.background-dark;
                                            border-radius: 6px;

                                            Text {
                                                x: 12px;
                                                text: pe-output-path != "" ? pe-output-path : "Click 'Browse' to select output location";
                                                color: pe-output-path != "" ? Theme.text-primary : Theme.text-muted;
                                                font-size: 12px;
                                                vertical-alignment: center;
                                                overflow: elide;
                                            }
                                        }

                                        Rectangle {
                                            width: 80px;
                                            height: 32px;
                                            background: Theme.button-bg;
                                            border-radius: 6px;

                                            Text {
                                                text: "Browse";
                                                color: Theme.text-primary;
                                                font-size: 12px;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                            }

                                            TouchArea {
                                                clicked => { pe-browse-output(); }
                                            }
                                        }
                                    }

                                    // NOTE: Drivers, tools, and network support are always included.
                                    // (Removed the Include checkboxes — disabling them breaks PE.)
                                }
                            }

                            // ========================================
                            // PE TOOLS SECTION
                            // ========================================
                            SectionHeader { text: "PE TOOLS"; }

                            Rectangle {
                                height: 320px;
                                background: Theme.card-bg;
                                border-radius: 8px;

                                VerticalBox {
                                    padding: 20px;
                                    spacing: 12px;

                                    // Header with Download All and Add Tool buttons
                                    HorizontalBox {
                                        spacing: 12px;

                                        Text {
                                            text: "Select tools to include in the PE environment:";
                                            color: Theme.text-secondary;
                                            font-size: 13px;
                                            vertical-alignment: center;
                                            horizontal-stretch: 1;
                                        }

                                        Text {
                                            text: pe-tools-summary;
                                            color: Theme.text-muted;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }

                                        // Download All PE Tools button (same style as backup tools)
                                        Rectangle {
                                            width: pe-tools-download-active ? 160px : 110px;
                                            height: 28px;
                                            background: pe-tools-download-active ? Theme.button-bg : Theme.accent-green;
                                            border-radius: 6px;

                                            Text {
                                                text: pe-tools-download-active
                                                    ? "Downloading " + pe-tools-download-progress + "..."
                                                    : "Download All";
                                                color: pe-tools-download-active ? Theme.text-muted : Theme.sidebar-bg;
                                                font-size: 11px;
                                                font-weight: 600;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                            }

                                            TouchArea {
                                                enabled: !pe-tools-download-active;
                                                clicked => { pe-download-all-tools(); }
                                            }
                                        }

                                        // (Add Tool button removed — not implemented for release)
                                    }

                                    // Default shell info (WinXShell is always the default shell)
                                    HorizontalBox {
                                        spacing: 8px;
                                        Text {
                                            text: "Default Shell: WinXShell";
                                            color: Theme.text-secondary;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                        }
                                        Text {
                                            text: "(launches on PE boot)";
                                            color: Theme.text-muted;
                                            font-size: 10px;
                                            vertical-alignment: center;
                                        }
                                    }

                                    // Divider
                                    Rectangle {
                                        height: 1px;
                                        background: Theme.button-bg;
                                    }

                                    // Tool categories in a grid (4 columns)
                                    HorizontalBox {
                                        spacing: 30px;

                                        // Shell & Desktop column
                                        VerticalBox {
                                            spacing: 8px;
                                            horizontal-stretch: 1;

                                            Text {
                                                text: "Shell & Desktop";
                                                color: Theme.accent-teal;
                                                font-size: 12px;
                                                font-weight: 600;
                                            }

                                            // WinXShell — wrapped in TouchArea for hover detection + click toggle
                                            ta-winxshell := TouchArea {
                                                clicked => { pe-tool-winxshell = !pe-tool-winxshell; }
                                                HorizontalBox {
                                                    spacing: 6px;
                                                    Rectangle { width: 16px; height: 16px; background: pe-tool-winxshell ? Theme.accent-teal : Theme.button-bg; border-radius: 3px;
                                                        Text { text: pe-tool-winxshell ? "✓" : ""; color: Theme.sidebar-bg; font-size: 10px; horizontal-alignment: center; vertical-alignment: center; }
                                                    }
                                                    Rectangle { width: 8px; height: 8px; border-radius: 4px; background: pe-tool-winxshell-present ? Theme.accent-green : Theme.accent-orange; }
                                                    Text { text: "WinXShell"; color: Theme.text-primary; font-size: 11px; }
                                                }
                                            }

                                            // Explorer++ — hover + click
                                            ta-explorer := TouchArea {
                                                clicked => { pe-tool-explorer = !pe-tool-explorer; }
                                                HorizontalBox {
                                                    spacing: 6px;
                                                    Rectangle { width: 16px; height: 16px; background: pe-tool-explorer ? Theme.accent-teal : Theme.button-bg; border-radius: 3px;
                                                        Text { text: pe-tool-explorer ? "✓" : ""; color: Theme.sidebar-bg; font-size: 10px; horizontal-alignment: center; vertical-alignment: center; }
                                                    }
                                                    Rectangle { width: 8px; height: 8px; border-radius: 4px; background: pe-tool-explorer-present ? Theme.accent-green : Theme.accent-orange; }
                                                    Text { text: "Explorer++"; color: Theme.text-primary; font-size: 11px; }
                                                }
                                            }

                                            // File Explorer (PE) — dual-pane explorer, hover + click
                                            ta-fileexplorer := TouchArea {
                                                clicked => { pe-tool-fileexplorer = !pe-tool-fileexplorer; }
                                                HorizontalBox {
                                                    spacing: 6px;
                                                    Rectangle { width: 16px; height: 16px; background: pe-tool-fileexplorer ? Theme.accent-teal : Theme.button-bg; border-radius: 3px;
                                                        Text { text: pe-tool-fileexplorer ? "✓" : ""; color: Theme.sidebar-bg; font-size: 10px; horizontal-alignment: center; vertical-alignment: center; }
                                                    }
                                                    Rectangle { width: 8px; height: 8px; border-radius: 4px; background: pe-tool-fileexplorer-present ? Theme.accent-green : Theme.accent-orange; }
                                                    Text { text: "File Explorer"; color: Theme.text-primary; font-size: 11px; }
                                                }
                                            }
                                        }

                                        // Network & Web column
                                        VerticalBox {
                                            spacing: 8px;
                                            horizontal-stretch: 1;

                                            Text {
                                                text: "Network & Web";
                                                color: Theme.accent-blue;
                                                font-size: 12px;
                                                font-weight: 600;
                                            }

                                            // PENetwork — hover + click
                                            ta-penetwork := TouchArea {
                                                clicked => { pe-tool-penetwork = !pe-tool-penetwork; }
                                                HorizontalBox {
                                                    spacing: 6px;
                                                    Rectangle { width: 16px; height: 16px; background: pe-tool-penetwork ? Theme.accent-teal : Theme.button-bg; border-radius: 3px;
                                                        Text { text: pe-tool-penetwork ? "✓" : ""; color: Theme.sidebar-bg; font-size: 10px; horizontal-alignment: center; vertical-alignment: center; }
                                                    }
                                                    Rectangle { width: 8px; height: 8px; border-radius: 4px; background: pe-tool-penetwork-present ? Theme.accent-green : Theme.accent-orange; }
                                                    Text { text: "PENetwork"; color: Theme.text-primary; font-size: 11px; }
                                                }
                                            }

                                            // Web Browser (PE) — compact browser, hover + click
                                            ta-webbrowser := TouchArea {
                                                clicked => { pe-tool-webbrowser = !pe-tool-webbrowser; }
                                                HorizontalBox {
                                                    spacing: 6px;
                                                    Rectangle { width: 16px; height: 16px; background: pe-tool-webbrowser ? Theme.accent-teal : Theme.button-bg; border-radius: 3px;
                                                        Text { text: pe-tool-webbrowser ? "✓" : ""; color: Theme.sidebar-bg; font-size: 10px; horizontal-alignment: center; vertical-alignment: center; }
                                                    }
                                                    Rectangle { width: 8px; height: 8px; border-radius: 4px; background: pe-tool-webbrowser-present ? Theme.accent-green : Theme.accent-orange; }
                                                    Text { text: "Web Browser"; color: Theme.text-primary; font-size: 11px; }
                                                }
                                            }
                                        }

                                        // Disk & System column
                                        VerticalBox {
                                            spacing: 8px;
                                            horizontal-stretch: 1;

                                            Text {
                                                text: "Disk & System";
                                                color: Theme.accent-orange;
                                                font-size: 12px;
                                                font-weight: 600;
                                            }

                                            // CrystalDiskInfo — hover + click
                                            ta-crystaldisk := TouchArea {
                                                clicked => { pe-tool-crystaldisk = !pe-tool-crystaldisk; }
                                                HorizontalBox {
                                                    spacing: 6px;
                                                    Rectangle { width: 16px; height: 16px; background: pe-tool-crystaldisk ? Theme.accent-teal : Theme.button-bg; border-radius: 3px;
                                                        Text { text: pe-tool-crystaldisk ? "✓" : ""; color: Theme.sidebar-bg; font-size: 10px; horizontal-alignment: center; vertical-alignment: center; }
                                                    }
                                                    Rectangle { width: 8px; height: 8px; border-radius: 4px; background: pe-tool-crystaldisk-present ? Theme.accent-green : Theme.accent-orange; }
                                                    Text { text: "CrystalDiskInfo"; color: Theme.text-primary; font-size: 11px; }
                                                }
                                            }

                                            // Disk Check (PE) — SMART monitoring, hover + click
                                            ta-diskcheck := TouchArea {
                                                clicked => { pe-tool-diskcheck = !pe-tool-diskcheck; }
                                                HorizontalBox {
                                                    spacing: 6px;
                                                    Rectangle { width: 16px; height: 16px; background: pe-tool-diskcheck ? Theme.accent-teal : Theme.button-bg; border-radius: 3px;
                                                        Text { text: pe-tool-diskcheck ? "✓" : ""; color: Theme.sidebar-bg; font-size: 10px; horizontal-alignment: center; vertical-alignment: center; }
                                                    }
                                                    Rectangle { width: 8px; height: 8px; border-radius: 4px; background: pe-tool-diskcheck-present ? Theme.accent-green : Theme.accent-orange; }
                                                    Text { text: "Disk Check"; color: Theme.text-primary; font-size: 11px; }
                                                }
                                            }

                                            // DISM Tool — GUI for DISM, hover + click
                                            ta-dismtool := TouchArea {
                                                clicked => { pe-tool-dismtool = !pe-tool-dismtool; }
                                                HorizontalBox {
                                                    spacing: 6px;
                                                    Rectangle { width: 16px; height: 16px; background: pe-tool-dismtool ? Theme.accent-teal : Theme.button-bg; border-radius: 3px;
                                                        Text { text: pe-tool-dismtool ? "✓" : ""; color: Theme.sidebar-bg; font-size: 10px; horizontal-alignment: center; vertical-alignment: center; }
                                                    }
                                                    Rectangle { width: 8px; height: 8px; border-radius: 4px; background: pe-tool-dismtool-present ? Theme.accent-green : Theme.accent-orange; }
                                                    Text { text: "DISM Tool"; color: Theme.text-primary; font-size: 11px; }
                                                }
                                            }
                                        }

                                        // Utilities column
                                        VerticalBox {
                                            spacing: 8px;
                                            horizontal-stretch: 1;

                                            Text {
                                                text: "Utilities";
                                                color: Theme.accent-red;
                                                font-size: 12px;
                                                font-weight: 600;
                                            }

                                            // 7-Zip — hover + click
                                            ta-7zip := TouchArea {
                                                clicked => { pe-tool-7zip = !pe-tool-7zip; }
                                                HorizontalBox {
                                                    spacing: 6px;
                                                    Rectangle { width: 16px; height: 16px; background: pe-tool-7zip ? Theme.accent-teal : Theme.button-bg; border-radius: 3px;
                                                        Text { text: pe-tool-7zip ? "✓" : ""; color: Theme.sidebar-bg; font-size: 10px; horizontal-alignment: center; vertical-alignment: center; }
                                                    }
                                                    Rectangle { width: 8px; height: 8px; border-radius: 4px; background: pe-tool-7zip-present ? Theme.accent-green : Theme.accent-orange; }
                                                    Text { text: "7-Zip"; color: Theme.text-primary; font-size: 11px; }
                                                }
                                            }

                                            // Autoruns — Sysinternals auto-start manager, hover + click
                                            ta-autoruns := TouchArea {
                                                clicked => { pe-tool-autoruns = !pe-tool-autoruns; }
                                                HorizontalBox {
                                                    spacing: 6px;
                                                    Rectangle { width: 16px; height: 16px; background: pe-tool-autoruns ? Theme.accent-teal : Theme.button-bg; border-radius: 3px;
                                                        Text { text: pe-tool-autoruns ? "✓" : ""; color: Theme.sidebar-bg; font-size: 10px; horizontal-alignment: center; vertical-alignment: center; }
                                                    }
                                                    Rectangle { width: 8px; height: 8px; border-radius: 4px; background: pe-tool-autoruns-present ? Theme.accent-green : Theme.accent-orange; }
                                                    Text { text: "Autoruns"; color: Theme.text-primary; font-size: 11px; }
                                                }
                                            }

                                            // Event Viewer (PE) — hover + click
                                            ta-eventviewer := TouchArea {
                                                clicked => { pe-tool-eventviewer = !pe-tool-eventviewer; }
                                                HorizontalBox {
                                                    spacing: 6px;
                                                    Rectangle { width: 16px; height: 16px; background: pe-tool-eventviewer ? Theme.accent-teal : Theme.button-bg; border-radius: 3px;
                                                        Text { text: pe-tool-eventviewer ? "✓" : ""; color: Theme.sidebar-bg; font-size: 10px; horizontal-alignment: center; vertical-alignment: center; }
                                                    }
                                                    Rectangle { width: 8px; height: 8px; border-radius: 4px; background: pe-tool-eventviewer-present ? Theme.accent-green : Theme.accent-orange; }
                                                    Text { text: "Event Viewer"; color: Theme.text-primary; font-size: 11px; }
                                                }
                                            }

                                            // Installed Software (PE) — hover + click
                                            ta-installedsw := TouchArea {
                                                clicked => { pe-tool-installedsw = !pe-tool-installedsw; }
                                                HorizontalBox {
                                                    spacing: 6px;
                                                    Rectangle { width: 16px; height: 16px; background: pe-tool-installedsw ? Theme.accent-teal : Theme.button-bg; border-radius: 3px;
                                                        Text { text: pe-tool-installedsw ? "✓" : ""; color: Theme.sidebar-bg; font-size: 10px; horizontal-alignment: center; vertical-alignment: center; }
                                                    }
                                                    Rectangle { width: 8px; height: 8px; border-radius: 4px; background: pe-tool-installedsw-present ? Theme.accent-green : Theme.accent-orange; }
                                                    Text { text: "Installed SW"; color: Theme.text-primary; font-size: 11px; }
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                            // ========================================
                            // ADVANCED OPTIONS SECTION
                            // ========================================
                            // ADK Packages and PE Fixes (collapsible)
                            SectionHeader { text: "ADVANCED OPTIONS (ADK Packages & Fixes)"; }

                            Rectangle {
                                height: 730px;
                                background: Theme.card-bg;
                                border-radius: 8px;

                                VerticalBox {
                                    padding: 20px;
                                    spacing: 16px;

                                    // Master toggles row
                                    HorizontalBox {
                                        spacing: 30px;

                                        // Install ADK Packages toggle
                                        HorizontalBox {
                                            spacing: 8px;
                                            Rectangle {
                                                width: 20px;
                                                height: 20px;
                                                background: pe-install-packages ? Theme.accent-teal : Theme.button-bg;
                                                border-radius: 4px;
                                                Text {
                                                    text: pe-install-packages ? "✓" : "";
                                                    color: Theme.sidebar-bg;
                                                    font-size: 12px;
                                                    horizontal-alignment: center;
                                                    vertical-alignment: center;
                                                }
                                                TouchArea {
                                                    clicked => { pe-install-packages = !pe-install-packages; }
                                                }
                                            }
                                            VerticalBox {
                                                spacing: 2px;
                                                Text {
                                                    text: "Install ADK Packages";
                                                    color: Theme.text-primary;
                                                    font-size: 13px;
                                                    font-weight: 600;
                                                }
                                                Text {
                                                    text: adk-found ? "ADK detected - packages available" : "Requires Windows ADK";
                                                    color: adk-found ? Theme.accent-green : Theme.text-muted;
                                                    font-size: 10px;
                                                }
                                            }
                                        }

                                        // Apply PE Fixes toggle
                                        HorizontalBox {
                                            spacing: 8px;
                                            Rectangle {
                                                width: 20px;
                                                height: 20px;
                                                background: pe-apply-fixes ? Theme.accent-teal : Theme.button-bg;
                                                border-radius: 4px;
                                                Text {
                                                    text: pe-apply-fixes ? "✓" : "";
                                                    color: Theme.sidebar-bg;
                                                    font-size: 12px;
                                                    horizontal-alignment: center;
                                                    vertical-alignment: center;
                                                }
                                                TouchArea {
                                                    clicked => { pe-apply-fixes = !pe-apply-fixes; }
                                                }
                                            }
                                            VerticalBox {
                                                spacing: 2px;
                                                Text {
                                                    text: "Apply PE Fixes";
                                                    color: Theme.text-primary;
                                                    font-size: 13px;
                                                    font-weight: 600;
                                                }
                                                Text {
                                                    text: "DPI scaling, compatibility fixes";
                                                    color: Theme.text-muted;
                                                    font-size: 10px;
                                                }
                                            }
                                        }

                                        Rectangle { horizontal-stretch: 1; }
                                    }

                                    // Divider
                                    Rectangle {
                                        height: 1px;
                                        background: Theme.button-bg;
                                    }

                                    // Two-column layout for packages and fixes
                                    HorizontalBox {
                                        spacing: 30px;

                                        // ========================================
                                        // ADK PACKAGES COLUMN
                                        // ========================================
                                        VerticalBox {
                                            spacing: 12px;
                                            horizontal-stretch: 1;
                                            opacity: pe-install-packages && adk-found ? 1.0 : 0.4;

                                            Text {
                                                text: "ADK Packages";
                                                color: Theme.accent-teal;
                                                font-size: 12px;
                                                font-weight: 700;
                                            }

                                            // Core & Scripting row
                                            HorizontalBox {
                                                spacing: 20px;

                                                // Core column
                                                VerticalBox {
                                                    spacing: 6px;
                                                    horizontal-stretch: 1;

                                                    Text { text: "Core"; color: Theme.text-secondary; font-size: 10px; }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-wmi ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-wmi ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-wmi = !pe-pkg-wmi; } }
                                                        }
                                                        Text { text: "WMI"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-netfx ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-netfx ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-netfx = !pe-pkg-netfx; } }
                                                        }
                                                        Text { text: ".NET"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-scripting ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-scripting ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-scripting = !pe-pkg-scripting; } }
                                                        }
                                                        Text { text: "Scripting"; color: Theme.text-primary; font-size: 10px; }
                                                    }
                                                }

                                                // PowerShell column
                                                VerticalBox {
                                                    spacing: 6px;
                                                    horizontal-stretch: 1;

                                                    Text { text: "PowerShell"; color: Theme.text-secondary; font-size: 10px; }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-powershell ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-powershell ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-powershell = !pe-pkg-powershell; } }
                                                        }
                                                        Text { text: "PowerShell"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-dism-cmdlets ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-dism-cmdlets ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-dism-cmdlets = !pe-pkg-dism-cmdlets; } }
                                                        }
                                                        Text { text: "DISM Cmdlets"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-hta ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-hta ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-hta = !pe-pkg-hta; } }
                                                        }
                                                        Text { text: "HTA Apps"; color: Theme.text-primary; font-size: 10px; }
                                                    }
                                                }
                                            }

                                            // Storage & Security row
                                            HorizontalBox {
                                                spacing: 20px;

                                                // Storage column
                                                VerticalBox {
                                                    spacing: 6px;
                                                    horizontal-stretch: 1;

                                                    Text { text: "Storage"; color: Theme.text-secondary; font-size: 10px; }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-storage-wmi ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-storage-wmi ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-storage-wmi = !pe-pkg-storage-wmi; } }
                                                        }
                                                        Text { text: "Storage WMI"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-enhanced-storage ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-enhanced-storage ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-enhanced-storage = !pe-pkg-enhanced-storage; } }
                                                        }
                                                        Text { text: "Enhanced"; color: Theme.text-primary; font-size: 10px; }
                                                    }
                                                }

                                                // Security column
                                                VerticalBox {
                                                    spacing: 6px;
                                                    horizontal-stretch: 1;

                                                    Text { text: "Security"; color: Theme.text-secondary; font-size: 10px; }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-secure-startup ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-secure-startup ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-secure-startup = !pe-pkg-secure-startup; } }
                                                        }
                                                        Text { text: "BitLocker"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-dot3svc ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-dot3svc ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-dot3svc = !pe-pkg-dot3svc; } }
                                                        }
                                                        Text { text: "802.1X Net"; color: Theme.text-primary; font-size: 10px; }
                                                    }
                                                }
                                            }

                                            // Network & Setup row
                                            HorizontalBox {
                                                spacing: 20px;

                                                // Network column
                                                VerticalBox {
                                                    spacing: 6px;
                                                    horizontal-stretch: 1;

                                                    Text { text: "Network"; color: Theme.text-secondary; font-size: 10px; }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-wifi ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-wifi ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-wifi = !pe-pkg-wifi; } }
                                                        }
                                                        Text { text: "WiFi"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-rndis ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-rndis ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-rndis = !pe-pkg-rndis; } }
                                                        }
                                                        Text { text: "USB Net"; color: Theme.text-primary; font-size: 10px; }
                                                    }
                                                }

                                                // Setup column
                                                VerticalBox {
                                                    spacing: 6px;
                                                    horizontal-stretch: 1;

                                                    Text { text: "Setup"; color: Theme.text-secondary; font-size: 10px; }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-setup ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-setup ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-setup = !pe-pkg-setup; } }
                                                        }
                                                        Text { text: "Win Setup"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-setup-client ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-setup-client ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-setup-client = !pe-pkg-setup-client; } }
                                                        }
                                                        Text { text: "Client"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-pkg-winrecfg ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-pkg-winrecfg ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-install-packages; clicked => { pe-pkg-winrecfg = !pe-pkg-winrecfg; } }
                                                        }
                                                        Text { text: "Recovery"; color: Theme.text-primary; font-size: 10px; }
                                                    }
                                                }
                                            }
                                        }

                                        // Vertical divider
                                        Rectangle {
                                            width: 1px;
                                            background: Theme.button-bg;
                                        }

                                        // ========================================
                                        // PE FIXES COLUMN
                                        // ========================================
                                        VerticalBox {
                                            spacing: 12px;
                                            horizontal-stretch: 1;
                                            opacity: pe-apply-fixes ? 1.0 : 0.4;

                                            Text {
                                                text: "PE Fixes & Workarounds";
                                                color: Theme.accent-orange;
                                                font-size: 12px;
                                                font-weight: 700;
                                            }

                                            // Display fixes
                                            HorizontalBox {
                                                spacing: 20px;

                                                VerticalBox {
                                                    spacing: 6px;
                                                    horizontal-stretch: 1;

                                                    Text { text: "Display"; color: Theme.text-secondary; font-size: 10px; }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-fix-dpi-scaling ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-fix-dpi-scaling ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-apply-fixes; clicked => { pe-fix-dpi-scaling = !pe-fix-dpi-scaling; } }
                                                        }
                                                        Text { text: "DPI Scaling"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-fix-wallpaper-host ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-fix-wallpaper-host ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-apply-fixes; clicked => { pe-fix-wallpaper-host = !pe-fix-wallpaper-host; } }
                                                        }
                                                        Text { text: "WallpaperHost"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-fix-font-fix ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-fix-font-fix ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-apply-fixes; clicked => { pe-fix-font-fix = !pe-fix-font-fix; } }
                                                        }
                                                        Text { text: "Font Fix"; color: Theme.text-primary; font-size: 10px; }
                                                    }
                                                }

                                                VerticalBox {
                                                    spacing: 6px;
                                                    horizontal-stretch: 1;

                                                    Text { text: "System"; color: Theme.text-secondary; font-size: 10px; }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-fix-profile-folders ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-fix-profile-folders ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-apply-fixes; clicked => { pe-fix-profile-folders = !pe-fix-profile-folders; } }
                                                        }
                                                        Text { text: "Profile Folders"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-fix-temp-folders ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-fix-temp-folders ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-apply-fixes; clicked => { pe-fix-temp-folders = !pe-fix-temp-folders; } }
                                                        }
                                                        Text { text: "TEMP Config"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-fix-file-associations ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-fix-file-associations ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-apply-fixes; clicked => { pe-fix-file-associations = !pe-fix-file-associations; } }
                                                        }
                                                        Text { text: "File Assoc."; color: Theme.text-primary; font-size: 10px; }
                                                    }
                                                }
                                            }

                                            // Compatibility fixes
                                            VerticalBox {
                                                spacing: 6px;

                                                Text { text: "Compatibility"; color: Theme.text-secondary; font-size: 10px; }

                                                HorizontalBox {
                                                    spacing: 15px;

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-fix-crash-dialogs ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-fix-crash-dialogs ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-apply-fixes; clicked => { pe-fix-crash-dialogs = !pe-fix-crash-dialogs; } }
                                                        }
                                                        Text { text: "No Crash Dialogs"; color: Theme.text-primary; font-size: 10px; }
                                                    }

                                                    HorizontalBox {
                                                        spacing: 4px;
                                                        Rectangle {
                                                            width: 14px; height: 14px;
                                                            background: pe-fix-long-paths ? Theme.accent-teal : Theme.button-bg;
                                                            border-radius: 3px;
                                                            Text { text: pe-fix-long-paths ? "✓" : ""; color: Theme.sidebar-bg; font-size: 9px; horizontal-alignment: center; vertical-alignment: center; }
                                                            TouchArea { enabled: pe-apply-fixes; clicked => { pe-fix-long-paths = !pe-fix-long-paths; } }
                                                        }
                                                        Text { text: "Long Paths"; color: Theme.text-primary; font-size: 10px; }
                                                    }
                                                }
                                            }
                                        }
                                    }

                                    // Divider before description
                                    Rectangle {
                                        height: 1px;
                                        background: Theme.button-bg;
                                    }

                                    // Hover description display
                                    Rectangle {
                                        height: 36px;
                                        background: Theme.background-dark;
                                        border-radius: 4px;

                                        HorizontalBox {
                                            padding-left: 12px;
                                            padding-right: 12px;

                                            Text {
                                                // Show a description when the user hovers over any PE tool checkbox.
                                                // Each ta-* is a named TouchArea wrapping one tool row above.
                                                text: ta-winxshell.has-hover ? "Desktop shell with taskbar, start menu, and system tray" :
                                                      ta-explorer.has-hover ? "Lightweight file manager with tabbed browsing" :
                                                      ta-fileexplorer.has-hover ? "Dual-pane file explorer with search (.NET 4.8)" :
                                                      ta-penetwork.has-hover ? "Network configuration - IP, DNS, WiFi, shares" :
                                                      ta-webbrowser.has-hover ? "Compact portable web browser (.NET 4.8)" :
                                                      ta-crystaldisk.has-hover ? "Disk health monitoring and SMART data" :
                                                      ta-diskcheck.has-hover ? "Monitor hard drive SMART status (.NET 4.8)" :
                                                      ta-dismtool.has-hover ? "GUI interface for DISM operations (.NET 4.8)" :
                                                      ta-7zip.has-hover ? "File archiver with high compression ratio" :
                                                      ta-autoruns.has-hover ? "View and manage auto-starting programs" :
                                                      ta-eventviewer.has-hover ? "Examine Windows event logs (.NET 4.8)" :
                                                      ta-installedsw.has-hover ? "List software installed on host systems (.NET 4.8)" :
                                                      "Hover over a tool to see its description";
                                                color: ta-winxshell.has-hover || ta-explorer.has-hover || ta-fileexplorer.has-hover ||
                                                       ta-penetwork.has-hover || ta-webbrowser.has-hover || ta-crystaldisk.has-hover ||
                                                       ta-diskcheck.has-hover || ta-dismtool.has-hover || ta-7zip.has-hover ||
                                                       ta-autoruns.has-hover || ta-eventviewer.has-hover || ta-installedsw.has-hover
                                                       ? Theme.text-primary : Theme.text-muted;
                                                font-size: 11px;
                                                vertical-alignment: center;
                                            }
                                        }
                                    }
                                }
                            }

                            // ========================================
                            // BUILD ACTIONS SECTION
                            // ========================================
                            SectionHeader { text: "BUILD"; }

                            Rectangle {
                                height: pe-building ? 120px : 80px;
                                background: Theme.card-bg;
                                border-radius: 8px;

                                VerticalBox {
                                    padding: 20px;
                                    spacing: 15px;

                                    HorizontalBox {
                                        spacing: 15px;

                                        // Build button
                                        Rectangle {
                                            width: 160px;
                                            height: 40px;
                                            background: (!pe-building && pe-output-path != "") ?
                                                        Theme.accent-teal : Theme.button-bg;
                                            border-radius: 8px;
                                            opacity: (!pe-building && pe-output-path != "") ? 1.0 : 0.5;

                                            Text {
                                                text: pe-building ? "Building..." :
                                                      pe-source == "LocalRE" ? "Apply to Recovery" :
                                                      pe-output-type == "USB" ? "Write to USB" :
                                                      pe-output-type == "VHD" ? "Create VHD" : "Build ISO";
                                                color: (!pe-building && pe-output-path != "") ?
                                                       Theme.sidebar-bg : Theme.text-muted;
                                                font-size: 14px;
                                                font-weight: 600;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                            }

                                            TouchArea {
                                                enabled: !pe-building && pe-output-path != "";
                                                clicked => { pe-build(); }
                                            }
                                        }

                                        // Open output folder button
                                        Rectangle {
                                            width: 140px;
                                            height: 40px;
                                            background: Theme.button-bg;
                                            border-radius: 8px;

                                            Text {
                                                text: "Open Output Folder";
                                                color: Theme.text-primary;
                                                font-size: 13px;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                            }

                                            TouchArea {
                                                clicked => { pe-open-output-folder(); }
                                            }
                                        }

                                        Rectangle { horizontal-stretch: 1; }

                                        // Status text
                                        Text {
                                            text: pe-build-status != "" ? pe-build-status :
                                                  (winre-found || pe-source == "ISO") && pe-output-path != "" ?
                                                  "Ready to build" : "Configure source and output path first";
                                            color: Theme.text-secondary;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                        }
                                    }

                                    // Progress bar (only shown when building)
                                    if pe-building: Rectangle {
                                        height: 24px;
                                        background: Theme.background-dark;
                                        border-radius: 4px;

                                        // Progress fill
                                        Rectangle {
                                            x: 0;
                                            width: parent.width * (pe-build-progress / 100.0);
                                            height: parent.height;
                                            background: Theme.accent-teal;
                                            border-radius: 4px;
                                        }

                                        // Progress text
                                        Text {
                                            text: pe-build-progress + "%";
                                            color: Theme.text-primary;
                                            font-size: 11px;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                            }

                            // ========================================
                            // HELP SECTION
                            // ========================================
                            Rectangle {
                                height: 80px;
                                background: Theme.sidebar-bg;
                                border-radius: 8px;

                                HorizontalBox {
                                    padding: 15px;
                                    spacing: 15px;

                                    Text {
                                        text: "💡";
                                        font-size: 20px;
                                        vertical-alignment: center;
                                    }

                                    VerticalBox {
                                        spacing: 4px;
                                        horizontal-stretch: 1;

                                        Text {
                                            text: "After building the ISO, use Rufus or Ventoy to create a bootable USB drive.";
                                            color: Theme.text-secondary;
                                            font-size: 12px;
                                            wrap: word-wrap;
                                        }
                                        Text {
                                            text: "The resulting WinPE will boot MasterBooter for Windows deployment and recovery.";
                                            color: Theme.text-muted;
                                            font-size: 11px;
                                        }
                                    }
                                }
                            }
                        }

                        // ============================
                        // SYSTEM PREP VIEW
                        // ============================
                        if current-mode == 3: VerticalBox {
                            spacing: 20px;

                            // Page title
                            Text {
                                text: "System Prep";
                                color: Theme.text-primary;
                                font-size: 28px;
                                font-weight: 700;
                            }
                            Text {
                                text: "Prepare a system for imaging with Sysprep.";
                                color: Theme.text-secondary;
                                font-size: 14px;
                            }

                            // Section header
                            Text {
                                text: "SYSPREP TOOLS";
                                color: Theme.text-secondary;
                                font-size: 12px;
                                font-weight: 600;
                                letter-spacing: 1px;
                            }

                            // Tool card row
                            HorizontalBox {
                                spacing: 15px;
                                alignment: start;

                                ToolCard {
                                    title: "Sysprep Preparator";
                                    description: "Wizard-based tool to prepare Windows for imaging. Runs compatibility checks, system cleanup, and sysprep.";
                                    badge: "By CodingWonders - Free";
                                    badge-color: Theme.accent-green;
                                    tool-id: "sysprepprep";
                                    clicked(id) => { tool-clicked(id); }
                                }
                            }

                            // Info box explaining what System Prep does
                            Rectangle {
                                background: Theme.card-bg;
                                border-radius: 8px;
                                min-height: 120px;

                                VerticalBox {
                                    padding: 20px;
                                    spacing: 8px;

                                    Text {
                                        text: "About System Prep";
                                        color: Theme.text-primary;
                                        font-size: 14px;
                                        font-weight: 600;
                                    }
                                    Text {
                                        text: "Sysprep (System Preparation) removes hardware-specific information from a Windows installation so it can be captured as a reusable image. This is essential for deploying the same Windows setup across multiple PCs.\n\nSysprep Preparator guides you through:\n  1. Pre-flight checks — detects issues that would cause sysprep to fail\n  2. System cleanup — removes temp files, caches, update leftovers\n  3. Sysprep execution — runs sysprep with your chosen options (OOBE/Audit, Generalize, Shutdown/Reboot)";
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                        wrap: word-wrap;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        // ========================================
        // STATUS BAR
        // ========================================
        Rectangle {
            height: 30px;
            background: Theme.status-bar-bg;

            HorizontalBox {
                padding-left: 15px;
                padding-right: 15px;

                // Status text (left)
                Text {
                    text: status-text;
                    color: Theme.text-secondary;
                    font-size: 12px;
                    vertical-alignment: center;
                    horizontal-stretch: 1;
                }

                // Version (right) — shows update status if available
                Text {
                    text: update-installed ? "MasterBooter " + version + " — Restart to update" :
                          update-available ? "MasterBooter " + version + " — Update available!" :
                          "MasterBooter " + version;
                    color: update-installed ? Theme.accent-orange :
                           update-available ? Theme.accent-green :
                           Theme.text-secondary;
                    font-size: 11px;
                    vertical-alignment: center;
                }
            }
        }
    }

    // ========================================
    // TOOL LAUNCHER POPUP (overlay)
    // ========================================
    if show-tool-popup: ToolLauncherPopup {
        width: 100%;
        height: 100%;
        tool-name: popup-tool-name;
        tool-description: popup-tool-description;
        tool-status: popup-tool-status;
        tool-installed: popup-tool-installed;
        tool-folder: popup-tool-folder;
        download-progress: popup-download-progress;

        launch-clicked => {
            tool-launch-clicked(popup-tool-id);
        }
        download-clicked => {
            tool-download-clicked(popup-tool-id);
        }
        open-folder-clicked => {
            tool-open-folder-clicked(popup-tool-id);
        }
        close-clicked => {
            show-tool-popup = false;
        }
    }
}
